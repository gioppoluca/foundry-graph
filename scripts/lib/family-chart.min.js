// https://donatso.github.io/family-chart/ v0.8.1 Copyright 2025 donatso
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).f3={},e.d3)}(this,function(e,t){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var i=n(t);function r(e,t,n){return n.find(n=>n.id!==t.id&&(n.id===e.rels.mother||n.id===e.rels.father))}function a(e,t,n){if(e.exiting=n,t)if(0!==e.depth||e.spouse)if(e.spouse)e._x=e.spouse.x,e._y=e.spouse.y;else if(e.is_ancestry){if(!e.parent)throw new Error("no parent");e._x=e.parent.x,e._y=e.parent.y}else e._x=e.psx,e._y=e.psy;else e._x=e.x,e._y=e.y;else if(n){const t=e.x>0?1:-1,n=e.y>0?1:-1;e._x=e.x+400*t,e._y=e.y+400*n}}function s(e,t){const n=t?"rels":"_rels",i=t?"_rels":"rels";function r(t){e.data[n]&&e.data[n][t]&&(e.data[i]||(e.data[i]={}),e.data[i][t]=e.data[n][t],delete e.data[n][t])}e.is_ancestry||e.data.main?(r("father"),r("mother")):function(){if(!e.data[n]||!e.data[n].children)return;const t=e.data[n].children.slice(0),r=e.spouse?[e.spouse]:e.spouses||[];[e,...r].forEach(e=>t.forEach(t=>{e.data[n].children.includes(t)&&(e.data[i]||(e.data[i]={}),e.data[i].children||(e.data[i].children=[]),e.data[i].children.push(t),e.data[n].children.splice(e.data[n].children.indexOf(t),1))}))}()}function o({tree:e,data_stash:t,private_cards_config:n}){const i={},r=n.condition;if(!r)return console.error("private_cards_config.condition is not set");e.forEach(e=>{if(e.data._new_rel_data)return;const n=function(e){const n=[];let a=!1;return s(e),i[e]=a,a;function s(e){if(a)return;if(i.hasOwnProperty(e))return a=i[e],a;const o=t.find(t=>t.id===e);if(!o)throw new Error("no d");if(o._new_rel_data)return;if(r(o))return a=!0,!0;const l=o.rels;[l.father,l.mother,...l.spouses||[]].forEach(e=>{e&&(n.includes(e)||(n.push(e),s(e)))})}}(e.data.id);n&&(e.is_private=n)})}function l(e,t){const n=t.find(t=>t.id===e);if(!n)throw new Error("no datum");const r=i.hierarchy(n,e=>function(e){return[e.rels.father,e.rels.mother].filter(e=>e).map(e=>t.find(t=>t.id===e)).filter(e=>e&&!e._new_rel_data&&!e.to_add)}(e)),a=i.hierarchy(n,e=>function(e){return[...e.rels.children||[]].map(e=>t.find(t=>t.id===e)).filter(e=>e&&!e._new_rel_data&&!e.to_add)}(e));return{ancestry:r.height,progeny:a.height}}function d({data:e,rels:t}){return{id:(n=(new Date).getTime(),i=performance&&performance.now&&1e3*performance.now()||0,"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random();return n>0?(t=(n+t)%16|0,n=Math.floor(n/16)):(t=(i+t)%16|0,i=Math.floor(i/16)),("x"===e?t:3&t|8).toString(16)})),data:e||{},rels:t||{}};var n,i}function c(e,t){const n=e.data.rels;return[n.father,n.mother,...n.spouses||[],...n.children||[]].filter(e=>e).every(e=>t.some(t=>t.data.id===e))}function h(e,t,n){const i=.4*n,r=Math.max(...e.data.map(e=>e.is_ancestry?e.depth:0));let a=t.depth*i;return 0===t.depth&&!t.spouse||t.is_ancestry||(a+=r*i,t.spouse&&(a+=i),a+=t.depth*i),a}function u(e,t,n=!0){const i=[];function r(e,t){return e.every(e=>t.some(t=>e.id===t.id))}function a(e){const t={},n=e;return(e.children||[]).forEach(e=>{const i=e.data.rels,r=i.father===n.data.id?i.mother:i.father;t[r]||(t[r]=[]),t[r].push(e)}),t}!function s(o){if(!o.children)return;const l=o.data,d=(o.data.rels.spouses||[]).map(e=>t.find(t=>t.id===e)),c=a(o);d.forEach(d=>{if(i.some(e=>e.some(e=>r([l,d],[e.p1,e.p2]))))return;const h=function(n,i,s){const o=[];return l(e),o;function l(e){if(e!==n&&e.children){const n=e.data,d=(e.data.rels.spouses||[]).map(e=>t.find(t=>t.id===e)),c=a(e);d.forEach(t=>{r([i,s],[n,t])?o.push({d:e,p1:n,p2:t}):(c[t.id]||[]).forEach(e=>{l(e)})})}}}(o,l,d);if(h.length>0){const t=[{d:o,p1:l,p2:d},...h];i.push(t),function(t){if(t.forEach(({d:n,p1:i,p2:r},a)=>{n.data._tgdp_sp||(n.data._tgdp_sp={});let s=e===n?"main":n.parent.data.id;!function(e,t,n){e.data.__tgdp_sp&&e.data.__tgdp_sp[t]&&e.data.__tgdp_sp[t].hasOwnProperty(n.id)&&(e.data._tgdp_sp[t][n.id]=e.data.__tgdp_sp[t][n.id],delete e.data.__tgdp_sp[t][n.id])}(n,s,r),n.data._tgdp_sp[s]||(n.data._tgdp_sp[s]={});let o=1;n.data._tgdp_sp[s].hasOwnProperty(r.id)?o=n.data._tgdp_sp[s][r.id]:n.data._tgdp_sp[s][r.id]=o,t[a].val=o}),n){if(t.every(e=>e.val<0)){const n=t.sort((e,t)=>t.val-e.val)[0],{d:i,p1:r,p2:a}=n,s=e===i?"main":i.parent.data.id;i.data._tgdp_sp[s][a.id]=1}if(t.filter(e=>e.val>0).length>1){const n=t.sort((e,t)=>t.val-e.val)[0];t.forEach(t=>{if(t===n)return;const{d:i,p1:r,p2:a}=t,s=e===i?"main":i.parent.data.id;i.data._tgdp_sp[s][a.id]=-1})}}}(t),function(t){t.forEach(({d:t,p1:n,p2:i})=>{const r=e===t?"main":t.parent.data.id;if(t.data._tgdp_sp[r][i.id]<0){const e=a(t);e[i.id]&&(t.children=t.children.filter(t=>!e[i.id].includes(t)),0===t.children.length&&delete t.children)}})}(t)}else{let t=e===o?"main":o.parent.data.id;!function(e,t,n){e.data._tgdp_sp&&e.data._tgdp_sp[t]&&e.data._tgdp_sp[t].hasOwnProperty(n.id)&&(e.data.__tgdp_sp||(e.data.__tgdp_sp={}),e.data.__tgdp_sp[t]||(e.data.__tgdp_sp[t]={}),e.data.__tgdp_sp[t][n.id]=e.data._tgdp_sp[t][n.id],delete e.data._tgdp_sp[t][n.id])}(o,t,d),(c[d.id]||[]).forEach(e=>{s(e)})}})}(e),function(e){let t=0;e.forEach(e=>{t+=1,e.forEach(e=>{e.d._toggle_id_sp||(e.d._toggle_id_sp={}),e.d._toggle_id_sp[e.p2.id]=t})})}(i)}function f(e,t=!0){const n=[];!function i(r){if(r.children){if(n.some(e=>e.includes(r)))return;const a=function(t){const n=[];return i(e),n;function i(e){var r,a;e.children&&(r=t,a=e.children,r!==a&&r.every(e=>a.some(t=>e.data.id===t.data.id))?n.push(e):e.children.forEach(e=>{i(e)}))}}(r.children);if(a.length>0){const i=[r,...a];n.push(i),function(n){if(n.forEach(t=>{t.data._tgdp||(t.data._tgdp={});const n=e===t?"main":t.parent.data.id;t.data._tgdp[n]||(t.data._tgdp[n]=-1),t._toggle=t.data._tgdp[n]}),t){if(n.every(e=>e._toggle<0)){const t=n.sort((e,t)=>t._toggle-e._toggle)[0],i=e===t?"main":t.parent.data.id;t.data._tgdp[i]=1}if(n.filter(e=>e._toggle>0).length>1){const t=n.sort((e,t)=>t._toggle-e._toggle)[0];n.forEach(n=>{if(n===t)return;const i=n,r=e===i?"main":i.parent.data.id;i.data._tgdp[r]=-1})}}}(i),function(t){t.forEach(t=>{const n=e===t?"main":t.parent.data.id;t.data._tgdp[n]<0&&delete t.children})}(i)}else r.children.forEach(e=>{i(e)})}}(e),function(e){let t=0;e.forEach(e=>{t+=1,e.forEach(e=>{e._toggle_id=t})})}(n)}function p(e,{main_id:t=null,node_separation:n=250,level_separation:a=150,single_parent_empty_card:s=!0,is_horizontal:l=!1,one_level_rels:h=!1,sortChildrenFunction:p,sortSpousesFunction:_,ancestry_depth:m,progeny_depth:g,show_siblings_of_main:v=!1,modifyTreeHierarchy:y,private_cards_config:w,duplicate_branch_toggle:b=!1,on_toggle_one_close_others:x=!0}){if(!e||!e.length)throw new Error("No data");l&&([n,a]=[a,n]);const C=s?function(e){const t=[];for(let t=0;t<e.length;t++){const i=e[t];if(i.rels.children&&i.rels.children.length>0){i.rels.spouses||(i.rels.spouses=[]);const t="M"===i.data.gender;let r;i.rels.children.forEach(a=>{const s=e.find(e=>e.id===a);s.rels[t?"father":"mother"]===i.id&&(s.rels[t?"mother":"father"]||(r||(r=n(i)),r.rels.children||(r.rels.children=[]),r.rels.children.push(s.id),s.rels[t?"mother":"father"]=r.id))})}}return t.forEach(t=>e.push(t)),e;function n(n){return(n.rels.spouses||[]).map(t=>e.find(e=>e.id===t)).filter(e=>void 0!==e).find(e=>e.to_add)||function(e){const n=d({data:{gender:"M"===e.data.gender?"F":"M"},rels:{spouses:[e.id],children:[]}});n.to_add=!0,t.push(n),e.rels.spouses||(e.rels.spouses=[]);return e.rels.spouses.push(n.id),n}(n)}}(e):e;t&&C.find(e=>e.id===t)||(t=C[0].id);const $=C.find(e=>e.id===t);if(!$)throw new Error("Main not found");const k=R($,"children",!1),S=R($,"parents",!0);C.forEach(e=>e.main=e===$),function(e,t){const n=(e[0].x-t[0].x)/2;e.forEach(e=>e.x-=n),t.forEach(e=>e.x+=n)}(S,k);const E=(I=k,(M=S).forEach(e=>{e.is_ancestry=!0}),M.forEach(e=>1===e.depth?e.parent=I[0]:null),[...I,...M.slice(1)]);var M,I;!function(e){e.forEach(t=>{if(delete t.children,e.forEach(e=>{e.parent===t&&(e.is_ancestry?(t.parents||(t.parents=[]),t.parents.push(e)):(t.children||(t.children=[]),t.children.push(e)))}),t.parents&&2===t.parents.length){const e=t.parents[0],n=t.parents[1];e.coparent=n,n.coparent=e}})}(E),function(e,t){for(let n=e.length;n--;){const i=e[n];if(!i.is_ancestry){let n=i.data.rels.spouses||[];if(i._ignore_spouses&&(n=n.filter(e=>!i._ignore_spouses.includes(e))),n.length>0){if(h&&i.depth>0)continue;const r="M"===i.data.data.gender?-1:1;i.x+=n.length/2*t*r,n.forEach((n,a)=>{const s={data:C.find(e=>e.id===n),added:!0,depth:i.depth,spouse:i,x:i.x-t*(a+1)*r,y:i.y,tid:`${i.data.id}-spouse-${a}`};s.sx=a>0?s.x:s.x+t/2*r,s.sy=a>0?s.y:s.y+t/2*r,i.spouses||(i.spouses=[]),i.spouses.push(s),e.push(s)})}}if(i.parents&&2===i.parents.length){const e=i.parents[0],n=i.parents[1],r=e.x-(e.x-n.x)/2,a=(e,n)=>r+t/2*(e.x<n.x?1:-1);n.x=a(e,n),e.x=a(n,e)}}}(E,n),v&&!h&&function({tree:e,data_stash:t,node_separation:n,sortChildrenFunction:r}){const a=e.find(e=>e.data.main);if(!a)throw new Error("no main");const s=a.data.rels.father,o=a.data.rels.mother,l=function(e){return t.filter(t=>!!(t.id!==e.data.id&&(s&&t.rels.father===s||o&&t.rels.mother===o)))}(a);if(l.length>0&&!a.parents)throw new Error("no parents");const d=function(t){const n=[];for(let i=0;i<l.length;i++){const r={data:l[i],sibling:!0,x:0,y:t.y,depth:t.depth-1,parents:[]},a=t.parents.find(e=>e.data.id===r.data.rels.father),s=t.parents.find(e=>e.data.id===r.data.rels.mother);a&&r.parents.push(a),s&&r.parents.push(s),e.push(r),n.push(r)}return n}(a);!function(e){var t,a;const s=[e,...d];r&&s.sort((e,t)=>r(e.data,t.data)),s.sort((t,n)=>{const i=e.parents.find(e=>e.data.id===t.data.rels.father),r=e.parents.find(e=>e.data.id===t.data.rels.mother),a=e.parents.find(e=>e.data.id===n.data.rels.father),s=e.parents.find(e=>e.data.id===n.data.rels.mother);return!r&&s?-1:r&&!s||!i&&a?1:i&&!a?-1:0});const o=e.x,l=(e.spouses||[]).map(e=>e.x),c=i.extent([o,...l]),h=s.findIndex(t=>t.data.id===e.data.id);for(let e=0;e<s.length;e++){if(e===h)continue;s[e].x=e<h?(null!==(t=c[0])&&void 0!==t?t:0)-n*(h-e):(null!==(a=c[1])&&void 0!==a?a:0)+n*(e-h)}}(a)}({tree:E,data_stash:C,node_separation:n,sortChildrenFunction:p}),function(e){e.forEach(e=>{if(e.is_ancestry)return;if(0===e.depth)return;if(e.added)return;if(e.sibling)return;const t=e.parent,n=((null==t?void 0:t.spouses)||[]).find(t=>t.data.id===e.data.rels.father||t.data.id===e.data.rels.mother);if(t&&n){t.added||n.added||console.error("no added spouse",t,n);const r=t.added?t:n;i(e,r)}else if(t||n){const r=t||n;if(!r)throw new Error("no progeny parent");r.sx=r.x,r.sy=r.y,i(e,r)}function i(e,t){e.psx=l?t.y:t.sx,e.psy=l?t.sx:t.y}})}(E),function(e){e.forEach(e=>{if(e.y*=e.is_ancestry?-1:1,l){const t=e.x;e.x=e.y,e.y=t}})}(E),E.forEach(e=>e.all_rels_displayed=c(e,E)),w&&o({tree:E,data_stash:C,private_cards_config:w}),function(e){const t=[];e.forEach(n=>{if(t.includes(n.data.id)){const i=e.filter(e=>e.data.id===n.data.id);i.forEach((e,r)=>{e.tid=`${n.data.id}--x${r+1}`,e.duplicate=i.length,t.push(n.data.id)})}else n.tid=n.data.id,t.push(n.data.id)})}(E),b&&function(e){e.forEach(e=>{if(!e.spouse)return;const t=e.spouse;if(e.duplicate&&t.data._tgdp_sp){const n=t.data.main?"main":t.parent.data.id;t.data._tgdp_sp[n]?.hasOwnProperty(e.data.id)&&(e._toggle=t.data._tgdp_sp[n][e.data.id])}})}(E);const A=function(e,t,n){l&&([t,n]=[n,t]);const r=i.extent(e,e=>e.x),a=i.extent(e,e=>e.y);if(void 0===r[0]||void 0===r[1]||void 0===a[0]||void 0===a[1])throw new Error("No extent");return{width:r[1]-r[0]+t,height:a[1]-a[0]+n,x_off:-r[0]+t/2,y_off:-a[0]+n/2}}(E,n,a);return{data:E,data_stash:C,dim:A,main_id:$.id,is_horizontal:l};function R(e,t,s){const o="children"===t?function(e){const t=[...e.rels.children||[]].map(e=>C.find(t=>t.id===e)).filter(e=>void 0!==e);p&&t.sort(p);(function(e){e.sort((e,t)=>{const n=e._new_rel_data,i=t._new_rel_data;return n&&!i?1:!n&&i?-1:0})})(t),_&&_(e,C);return function(e,t,n){if(!t.rels.children)return;const i=t.rels.spouses||[];e.sort((e,a)=>{const s=r(e,t,n),o=r(a,t,n),l=s?i.indexOf(s.id):-1,d=o?i.indexOf(o.id):-1;return"M"===t.data.gender?l-d:d-l})}(t,e,C),t}:function(e){return[e.rels.father,e.rels.mother].filter(e=>e).map(e=>C.find(t=>t.id===e)).filter(e=>void 0!==e)},l=i.tree().nodeSize([n,a]).separation(function(e,t){let n=1;s||(v(e,t)||(n+=.25),h||function(e,t){return w(e)||w(t)}(e,t)&&(n+=function(e,t){return.5*((e.data.rels.spouses||[]).length+(t.data.rels.spouses||[]).length)}(e,t)),v(e,t)&&!function(e,t){return e.data.rels.father===t.data.rels.father&&e.data.rels.mother===t.data.rels.mother}(e,t)&&(n+=.125));return n}),d=i.hierarchy(e,o);!function(e,t){let n=t?m:g;h&&(n=1);return n||0===n?(i(e,0),e):e;function i(e,t){t===n?e.children&&delete e.children:e.children&&e.children.forEach(e=>{i(e,t+1)})}}(d,s),b&&function(e,t,n){n?f(e,x):u(e,t,x)}(d,C,s),y&&y(d,s),l(d);const c=d.descendants();return c.forEach(e=>{void 0===e.x&&(e.x=0),void 0===e.y&&(e.y=0)}),c;function v(e,t){return e.parent==t.parent}function w(e){return e.data.rels.spouses&&e.data.rels.spouses.length>0}}}function _(e){return p(e.data,e)}function m(e){let t;const n=Object.assign({transition_time:1e3},e);n.main_id_history=[];return{state:n,updateTree:e=>{n.data&&0!==n.data.length&&(n.tree=function(){const e={main_id:n.main_id};void 0!==n.node_separation&&(e.node_separation=n.node_separation);void 0!==n.level_separation&&(e.level_separation=n.level_separation);void 0!==n.single_parent_empty_card&&(e.single_parent_empty_card=n.single_parent_empty_card);void 0!==n.is_horizontal&&(e.is_horizontal=n.is_horizontal);void 0!==n.one_level_rels&&(e.one_level_rels=n.one_level_rels);void 0!==n.modifyTreeHierarchy&&(e.modifyTreeHierarchy=n.modifyTreeHierarchy);void 0!==n.sortChildrenFunction&&(e.sortChildrenFunction=n.sortChildrenFunction);void 0!==n.sortSpousesFunction&&(e.sortSpousesFunction=n.sortSpousesFunction);void 0!==n.ancestry_depth&&(e.ancestry_depth=n.ancestry_depth);void 0!==n.progeny_depth&&(e.progeny_depth=n.progeny_depth);void 0!==n.show_siblings_of_main&&(e.show_siblings_of_main=n.show_siblings_of_main);void 0!==n.private_cards_config&&(e.private_cards_config=n.private_cards_config);void 0!==n.duplicate_branch_toggle&&(e.duplicate_branch_toggle=n.duplicate_branch_toggle);return p(n.data,e)}(),!n.main_id&&n.tree&&r(n.tree.main_id),t&&t(e))},updateData:e=>{n.data=e,function(){if(n.main_id){!n.data.find(e=>e.id===n.main_id)&&n.data.length>0&&r(n.data[0].id)}else n.data.length>0&&r(n.data[0].id)}()},updateMainId:r,getMainId:()=>n.main_id,getData:()=>n.data,getTree:()=>n.tree,setOnUpdate:e=>t=e,getMainDatum:function(){const e=n.data.find(e=>e.id===n.main_id);if(!e)throw new Error("Main datum not found");return e},getDatum:i,getTreeMainDatum:function(){if(!n.tree)throw new Error("No tree");const e=n.tree.data.find(e=>e.data.id===n.main_id);if(!e)throw new Error("No tree main datum");return e},getTreeDatum:function(e){if(!n.tree)throw new Error("No tree");const t=n.tree.data.find(t=>t.data.id===e);return t||void 0},getLastAvailableMainDatum:function(){let e=n.main_id_history.slice(0).reverse().find(e=>i(e));!e&&n.data.length>0&&(e=n.data[0].id);if(!e)throw new Error("No main id");e!==n.main_id&&r(e);const t=i(e);if(!t)throw new Error("Main datum not found");return t},methods:{}};function i(e){const t=n.data.find(t=>t.id===e);if(t)return t}function r(e){e!==n.main_id&&(n.main_id_history=n.main_id_history.filter(t=>t!==e).slice(-10),n.main_id_history.push(e),n.main_id=e)}}function g({t:e,svg:t,transition_time:n=2e3}){const r=$(t),a=r.__zoomObj;i.select(r).transition().duration(n||0).delay(n?100:0).call(a.transform,i.zoomIdentity.scale(e.k).translate(e.x,e.y))}function v({svg:e,svg_dim:t,tree_dim:n,transition_time:i}){g({t:y(t,n),svg:e,transition_time:i})}function y(e,t){let n=Math.min(e.width/t.width,e.height/t.height);n>1&&(n=1);return{k:n,x:t.x_off+(e.width-t.width*n)/n/2,y:t.y_off+(e.height-t.height*n)/n/2}}function w({datum:e,svg:t,svg_dim:n,scale:i,transition_time:r}){const a=i||1;g({t:{k:a,x:(n.width/2-e.x*a)/a,y:(n.height/2-e.y)/a},svg:t,transition_time:r})}function b({amount:e,svg:t,transition_time:n=500}){const r=$(t),a=r.__zoomObj;if(!a)throw new Error("Zoom object not found");i.select(r).transition().duration(n||0).delay(n?100:0).call(a.scaleBy,e)}function x(e){const t=$(e);return i.zoomTransform(t)}function C(e,t){const n=$(e);b({amount:t/i.zoomTransform(n).k,svg:e})}function $(e){const t=e.__zoomObj?e:e.parentNode;if(!t.__zoomObj)throw new Error("Zoom object not found");return t}function k(e,t={}){if(e.__zoom)return void console.log("zoom already setup");const n=e.querySelector(".view"),r=i.zoom().on("zoom",t.onZoom||function(e){i.select(n).attr("transform",e.transform)});i.select(e).call(r),e.__zoomObj=r,t.zoom_polite&&r.filter(function(e){return!("wheel"===e.type&&!e.ctrlKey)&&!(e.touches&&e.touches.length<2)})}function S(e,t,n={}){const r=t.data.reduce((e,n)=>(function(e,t=!1){const n=[];return(e.spouses||e.coparent)&&function(e){function t(e,t){return{d:[[e.x,e.y],[t.x,t.y]],_d:()=>[e.is_ancestry?[r(e,"x")-1e-4,r(e,"y")]:[e.x,e.y],e.is_ancestry?[r(t,"x"),r(t,"y")]:[e.x-1e-4,e.y]],curve:!1,id:s(e,t),depth:e.depth,spouse:!0,is_ancestry:t.is_ancestry,source:e,target:t}}e.spouses?e.spouses.forEach(i=>n.push(t(e,i))):e.coparent&&n.push(t(e,e.coparent))}(e),function(e){if(!e.parents)return;const t=e.parents[0],r=e.parents[1]||t,o={x:i(t,r,"x"),y:i(t,r,"y")};n.push({d:a(e,o),_d:()=>a({x:e.x,y:e.y},{x:e.x,y:e.y}),curve:!0,id:s(e,t,r),depth:e.depth+1,is_ancestry:!0,source:e,target:[t,r]})}(e),function(e){e.children&&0!==e.children.length&&e.children.forEach((i,o)=>{const l=function(e,t){const n=(t.spouses||[]).find(t=>t.data.id===e.data.rels.mother||t.data.id===e.data.rels.father);return n}(i,e)||e,d=l.sx;if("number"!=typeof d)throw new Error("sx is not a number");const c=t?{x:e.x,y:d}:{x:d,y:e.y};n.push({d:a(i,c),_d:()=>a(c,{x:r(c,"x"),y:r(c,"y")}),curve:!0,id:s(i,e,l),depth:e.depth+1,is_ancestry:!1,source:[e,l],target:i})})}(e),n;function i(e,t,n,i=!1){return i?r(e,n)-(r(e,n)-r(t,n))/2:e[n]-(e[n]-t[n])/2}function r(e,t){const n=e.hasOwnProperty(`_${t}`)?e[`_${t}`]:e[t];if("number"!=typeof n)throw new Error(`${t} is not a number`);return n}function a(e,n){return t?function(e,t){const n=e.x+(t.x-e.x)/2;return[[e.x,e.y],[n,e.y],[n,e.y],[n,t.y],[n,t.y],[t.x,t.y]]}(e,n):function(e,t){const n=e.y+(t.y-e.y)/2;return[[e.x,e.y],[e.x,n],[e.x,n],[t.x,n],[t.x,n],[t.x,t.y]]}(e,n)}function s(...e){return e.map(e=>e.tid).sort().join(", ")}}(n,t.is_horizontal).forEach(t=>e[t.id]=t),e),{}),a=Object.values(r),s=i.select(e).select(".links_view").selectAll("path.link").data(a,e=>e.id);if(void 0===n.transition_time)throw new Error("transition_time is undefined");const o=s.exit(),l=s.enter().append("path").attr("class","link"),d=l.merge(s);o.each(function(e){const t=i.select(this);t.transition("op").duration(800).style("opacity",0),t.transition("path").duration(n.transition_time).attr("d",E(e,!0)).on("end",()=>t.remove())}),l.each(function(e){i.select(this).attr("fill","none").attr("stroke","#fff").attr("stroke-width",1).style("opacity",0).attr("d",E(e,!0))}),d.each(function(e){const r=i.select(this),a=n.initial?h(t,e,n.transition_time):0;r.transition("path").duration(n.transition_time).delay(a).attr("d",E(e)).style("opacity",1)})}function E(e,t=!1){const n=i.line().curve(i.curveMonotoneY),r=i.line().curve(i.curveBasis),a=t?e._d():e.d;return e.curve?r(a):n(a)}function M(e,t={}){const n=e.getBoundingClientRect(),r=`\n    <svg class="main_svg">\n      <rect width="${n.width}" height="${n.height}" fill="transparent" />\n      <g class="view">\n        <g class="links_view"></g>\n        <g class="cards_view"></g>\n      </g>\n      <g style="transform: translate(100%, 100%)">\n        <g class="fit_screen_icon cursor-pointer" style="transform: translate(-50px, -50px); display: none">\n          <rect width="27" height="27" stroke-dasharray="13.5" stroke-dashoffset="6.75" \n            style="stroke:#fff;stroke-width:4px;fill:transparent;"/>\n          <circle r="5" cx="13.5" cy="13.5" style="fill:#fff" />          \n        </g>\n      </g>\n    </svg>\n  `,a=function(e){let t=e.querySelector("#f3Canvas");t||(t=i.create("div").attr("id","f3Canvas").attr("style","position: relative; overflow: hidden; width: 100%; height: 100%;").node());return t}(e),s=i.create("div").node();s.innerHTML=r;const o=s.querySelector("svg");return a.appendChild(o),e.appendChild(a),k(a,t),o}function I(e){return M(e,{onZoom:R(()=>e.querySelector("svg .view"),()=>e.querySelector("#htmlSvg .cards_view"))}),A(e),{svg:e.querySelector("svg.main_svg"),svgView:e.querySelector("svg .view"),htmlSvg:e.querySelector("#htmlSvg"),htmlView:e.querySelector("#htmlSvg .cards_view")}}function A(e){const t=i.select(e).select("#f3Canvas").append("div").attr("id","htmlSvg").attr("style","position: absolute; width: 100%; height: 100%; z-index: 2; top: 0; left: 0");return t.append("div").attr("class","cards_view").style("transform-origin","0 0"),t.node()}function R(e,t){return function(n){const r=n.transform;i.select(e()).style("transform",`translate(${r.x}px, ${r.y}px) scale(${r.k}) `),i.select(t()).style("transform",`translate(${r.x}px, ${r.y}px) scale(${r.k}) `)}}var H=Object.freeze({__proto__:null,createHtmlSvg:A,default:I,onZoomSetup:R});function L(e){let t=[];return function(n){const r=function(e,t){return t.length>0?t.filter(t=>!e.find(e=>e.data.id===t.data.id)):[]}(n,t);return t=[...n,...r],function(e,t){const n=i.select(e).selectAll("div.card_cont_2fake").data(t,e=>e.data.id),r=n.exit(),a=n.enter().append("div").attr("class","card_cont_2fake").style("display","none").attr("data-id",()=>Math.random()),s=a.merge(n);function o(e){e.unique_id=i.select(this).attr("data-id")}function l(e){e.unique_id=i.select(this).attr("data-id")}function d(e){e&&(e.unique_id=i.select(this).attr("data-id"),i.select(this).remove())}r.each(d),a.each(o),s.each(l)}(D(e),t),t}}function D(e){return i.select(e()).select("div.cards_view_fake").node()}const F=L;function O(e,t,n,r={}){r.initial=r.hasOwnProperty("initial")?r.initial:!i.select(t.parentNode).select(".card_cont").node(),r.transition_time=r.hasOwnProperty("transition_time")?r.transition_time:1e3,r.cardComponent?function(e,t,n,r={}){const s=r.cardHtmlDiv?r.cardHtmlDiv:e.closest("#f3Canvas").querySelector("#htmlSvg"),o=i.select(D(()=>s)).selectAll("div.card_cont_fake").data(t.data,e=>e.data.id),l=o.exit(),d=o.enter().append("div").attr("class","card_cont_fake").style("display","none"),c=d.merge(o);l.each(e=>a(e,!1,!0)),d.each(e=>a(e,!0,!1)),l.each(function(e){const t=e,a=t?[t._x,t._y]:[0,0],s=i.select(n(e)),o=i.select(this);s.transition().duration(r.transition_time).style("opacity",0).style("transform",`translate(${a[0]}px, ${a[1]}px)`).on("end",()=>o.remove())}),o.each(function(e){}),d.each(function(e){i.select(n(e)).style("position","absolute").style("top","0").style("left","0").style("opacity",0).style("transform",`translate(${e._x}px, ${e._y}px)`)}),c.each(function(e){const a=i.select(n(e)),s=r.initial?h(t,e,r.transition_time):0;a.transition().duration(r.transition_time).delay(s).style("transform",`translate(${e.x}px, ${e.y}px)`).style("opacity",1)})}(t,e,n,r):r.cardHtml?function(e,t,n,r={}){const s=function(e){if(r.cardHtmlDiv)return r.cardHtmlDiv;const t=e.closest("#f3Canvas");if(!t)throw new Error("canvas not found");const n=t.querySelector("#htmlSvg");if(!n)throw new Error("htmlSvg not found");return n}(e),o=i.select(s).select(".cards_view").selectAll("div.card_cont").data(t.data,e=>e.tid),l=o.exit(),d=o.enter().append("div").attr("class","card_cont").style("pointer-events","none"),c=d.merge(o);l.each(e=>a(e,!1,!0)),d.each(e=>a(e,!0,!1)),l.each(function(e){const t=e,n=t?[t._x,t._y]:[0,0],a=i.select(this);a.transition().duration(r.transition_time).style("opacity",0).style("transform",`translate(${n[0]}px, ${n[1]}px)`).on("end",()=>a.remove())}),o.each(function(e){}),d.each(function(e){i.select(this).style("position","absolute").style("top","0").style("left","0").style("transform",`translate(${e._x}px, ${e._y}px)`).style("opacity",0),n.call(this,e)}),c.each(function(e){n.call(this,e);const a=r.initial?h(t,e,r.transition_time):0;i.select(this).transition().duration(r.transition_time).delay(a).style("transform",`translate(${e.x}px, ${e.y}px)`).style("opacity",1)})}(t,e,n,r):function(e,t,n,r={}){const s=i.select(e).select(".cards_view").selectAll("g.card_cont").data(t.data,e=>e.data.id),o=s.exit(),l=s.enter().append("g").attr("class","card_cont"),d=l.merge(s);o.each(e=>a(e,!1,!0)),l.each(e=>a(e,!0,!1)),o.each(function(e){const t=e,n=t?[t._x,t._y]:[0,0],a=i.select(this);a.transition().duration(r.transition_time).style("opacity",0).attr("transform",`translate(${n[0]}, ${n[1]})`).on("end",()=>a.remove())}),s.each(function(e){}),l.each(function(e){i.select(this).attr("transform",`translate(${e._x}, ${e._y})`).style("opacity",0),n.call(this,e)}),d.each(function(e){n.call(this,e);const a=r.initial?h(t,e,r.transition_time):0;i.select(this).transition().duration(r.transition_time).delay(a).attr("transform",`translate(${e.x}, ${e.y})`).style("opacity",1)})}(t,e,n,r),S(t,e,r);const s=r.tree_position||"fit";return r.initial?v({svg:t,svg_dim:t.getBoundingClientRect(),tree_dim:e.dim,transition_time:0}):"fit"===s?v({svg:t,svg_dim:t.getBoundingClientRect(),tree_dim:e.dim,transition_time:r.transition_time}):"main_to_middle"===s&&w({datum:e.data[0],svg:t,svg_dim:t.getBoundingClientRect(),scale:r.scale,transition_time:r.transition_time}),!0}function T(e,{d:t}){var n,i;return n=e.getTree().data,i=!1,n.forEach(e=>{e.data.hide_rels=i,s(e,i)}),e.updateMainId(t.data.id),e.updateTree({}),!0}function P(e,{d:t}){t.data.hide_rels=!t.data.hide_rels,s(t,t.data.hide_rels),e.updateTree({})}function q(e,t){const n=e.rels,i=[n.father,n.mother,...n.spouses||[],...n.children||[]].filter(e=>!!e);for(const n of i){if(!j(t.find(e=>e.id===n),t,[e.id]))return!1}return!0}function j(e,t,n=[]){const i=t[0];if(e.id===i.id)return!0;const r=[...n];let a=!1;return function e(n){if(a)return;const s=n.rels;[s.father,s.mother,...s.spouses||[],...s.children||[]].filter(e=>!!e).forEach(n=>{if(r.includes(n))return;r.push(n);const s=t.find(e=>e.id===n);s.id===i.id?a=!0:e(s)})}(e),a}function z(e,t,n){n.forEach((t,n)=>e.data[n]=t),V(e,t),e.to_add&&delete e.to_add,e.unknown&&delete e.unknown}function V(e,t){Object.keys(e.data).forEach(n=>{if(n.includes("__ref__")){const i=n.split("__ref__")[1],r=t.find(e=>e.id===i);if(!r)return;const a=n.split("__ref__")[0]+"__ref__"+e.id;r.data[a]=e.data[n]}})}function N(e,t){Object.keys(e.data).forEach(n=>{if(n.includes("__ref__")){const i=n.split("__ref__")[1],r=t.find(e=>e.id===i);if(!r)return;const a=n.split("__ref__")[0]+"__ref__"+e.id;delete r.data[a]}})}function U(e,t){return B(e,t,!1),!1}function B(e,t,n=!0){return q(e,t)?(t.forEach(t=>{for(let n in t.rels){if(!t.rels.hasOwnProperty(n))continue;const i=n;t.rels[i]===e.id?delete t.rels[i]:Array.isArray(t.rels[i])&&t.rels[i].includes(e.id)&&t.rels[i].splice(t.rels[i].findIndex(t=>t===e.id),1)}}),N(e,t),t.splice(t.findIndex(t=>t.id===e.id),1),0===t.length&&t.push(d({data:{gender:"M"}})),n&&J(t),{success:!0}):(N(e,t),e.data={gender:e.data.gender},e.unknown=!0,{success:!0})}function Z(e){return J(e),e.forEach(e=>{delete e.main,delete e._tgdp,delete e._tgdp_sp,delete e.__tgdp_sp}),e.forEach(e=>{Object.keys(e).forEach(e=>{"_"===e[0]&&console.error("key starts with _",e)})}),e}function J(e){for(let t=e.length-1;t>=0;t--)e[t].to_add&&U(e[t],e)}function W(){return`\n    <g data-icon="user">\n      ${Ee()}\n      <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />\n    </g>\n  `}function G(){return`\n    <g data-icon="user-edit">\n      ${Ee()}\n      <path d="M21.7,13.35L20.7,14.35L18.65,12.3L19.65,11.3C19.86,11.09 20.21,11.09 20.42,11.3L21.7,12.58C21.91,\n      12.79 21.91,13.14 21.7,13.35M12,18.94L18.06,12.88L20.11,14.93L14.06,21H12V18.94M12,14C7.58,14 4,15.79 4,\n      18V20H10V18.11L14,14.11C13.34,14.03 12.67,14 12,14M12,4A4,4 0 0,0 8,8A4,4 0 0,0 12,12A4,4 0 0,0 16,8A4,4 0 0,0 12,4Z" />\n    </g>\n  `}function K(){return`\n    <g data-icon="user-plus">\n      ${Ee()}\n      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />\n    </g>\n  `}function Y(){return`\n    <g data-icon="user-plus-close">\n      ${Ee()}\n      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />\n      <line x1="3" y1="3" x2="24" y2="24" stroke="currentColor" stroke-width="2" />\n    </g>\n  `}function Q(){return`\n    <g data-icon="plus">\n      ${Ee()}\n      <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />\n    </g>\n  `}function X(){return`\n    <g data-icon="pencil">\n      ${Ee()}\n      <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />\n    </g>\n  `}function ee(){return`\n    <g data-icon="pencil-off">\n      ${Ee()}\n      <path d="M18.66,2C18.4,2 18.16,2.09 17.97,2.28L16.13,4.13L19.88,7.88L21.72,6.03C22.11,5.64 22.11,5 21.72,4.63L19.38,2.28C19.18,2.09 18.91,2 18.66,2M3.28,4L2,5.28L8.5,11.75L4,16.25V20H7.75L12.25,15.5L18.72,22L20,20.72L13.5,14.25L9.75,10.5L3.28,4M15.06,5.19L11.03,9.22L14.78,12.97L18.81,8.94L15.06,5.19Z" />\n    </g>\n  `}function te(){return`\n    <g data-icon="trash">\n      ${Ee()}\n      <path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z" />\n    </g>\n  `}function ne(){return`\n    <g data-icon="history-back">\n      ${Ee()}\n      <path d="M20 13.5C20 17.09 17.09 20 13.5 20H6V18H13.5C16 18 18 16 18 13.5S16 9 13.5 9H7.83L10.91 12.09L9.5 13.5L4 8L9.5 2.5L10.92 3.91L7.83 7H13.5C17.09 7 20 9.91 20 13.5Z" />\n    </g>\n  `}function ie(){return`\n    <g data-icon="history-forward">\n      ${Ee()}\n      <path d="M10.5 18H18V20H10.5C6.91 20 4 17.09 4 13.5S6.91 7 10.5 7H16.17L13.08 3.91L14.5 2.5L20 8L14.5 13.5L13.09 12.09L16.17 9H10.5C8 9 6 11 6 13.5S8 18 10.5 18Z" />\n    </g>\n  `}function re(){return'\n    <g data-icon="person">\n      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n    </g>\n  '}function ae(){return'\n    <g transform="translate(31,25)" data-icon="mini-tree">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g>\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  '}function se(){return`\n    <g data-icon="toggle-on">\n      ${Ee()}\n      <circle class="f3-small-circle" r="4" cx="18" cy="12" />\n      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M17,15A3,3 0 0,1 14,12A3,3 0 0,1 17,9A3,3 0 0,1 20,12A3,3 0 0,1 17,15Z" />\n    </g>\n  `}function oe(){return`\n    <g data-icon="toggle-off">\n      ${Ee()}\n      <circle class="f3-small-circle" r="4" cx="6" cy="12" />\n      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M7,15A3,3 0 0,1 4,12A3,3 0 0,1 7,9A3,3 0 0,1 10,12A3,3 0 0,1 7,15Z" />\n    </g>\n  `}function le(){return`\n    <g data-icon="chevron-down">\n      ${Ee()}\n      <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />\n    </g>\n  `}function de(){return`\n    <g data-icon="chevron-up">\n      ${Ee()}\n      <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />\n    </g>\n  `}function ce(){return`\n    <g data-icon="link-off">\n      ${Ee()}\n      <path d="M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.43 19.12,14.63 17.79,15L19.25,16.44C20.88,15.61 22,13.95 \n      22,12A5,5 0 0,0 17,7M16,11H13.81L15.81,13H16V11M2,4.27L5.11,7.38C3.29,8.12 2,9.91 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 \n      3.9,13.71 3.9,12C3.9,10.41 5.11,9.1 6.66,8.93L8.73,11H8V13H10.73L13,15.27V17H14.73L18.74,21L20,19.74L3.27,3L2,4.27Z" />\n    </g>\n  `}function he(){return`\n    <g data-icon="info">\n      ${Ee()}\n      <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />\n    </g>\n  `}function ue(){return Se(K())}function fe(){return Se(Y())}function pe(){return Se(Q())}function _e(){return Se(X())}function me(){return Se(ee())}function ge(){return Se(ne())}function ve(){return Se(ie())}function ye(){return Se('\n    <g data-icon="person">\n      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n    </g>\n  ',"0 0 512 512")}function we(){return Se('\n    <g transform="translate(31,25)" data-icon="mini-tree">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g>\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  ',"0 0 72 25")}function be(){return Se(se())}function xe(){return Se(oe())}function Ce(){return Se(le())}function $e(){return Se(ce())}function ke(){return Se(he())}function Se(e,t="0 0 24 24"){const n=e.match(/data-icon="([^"]+)"/);return`\n    <svg xmlns="http://www.w3.org/2000/svg" viewBox="${t}" style="fill: currentColor" ${n?`data-icon="${n[1]}"`:""}>\n      ${e}\n    </svg>\n  `}function Ee(){return'\n    <circle r="12" cx="12" cy="12" style="fill: rgba(0,0,0,0)" />\n  '}var Me=Object.freeze({__proto__:null,chevronDownIcon:le,chevronDownSvgIcon:Ce,chevronUpIcon:de,chevronUpSvgIcon:function(){return Se(de())},historyBackIcon:ne,historyBackSvgIcon:ge,historyForwardIcon:ie,historyForwardSvgIcon:ve,infoIcon:he,infoSvgIcon:ke,linkOffIcon:ce,linkOffSvgIcon:$e,miniTreeIcon:ae,miniTreeSvgIcon:we,pencilIcon:X,pencilOffIcon:ee,pencilOffSvgIcon:me,pencilSvgIcon:_e,personIcon:re,personSvgIcon:ye,plusIcon:Q,plusSvgIcon:pe,toggleIconOff:oe,toggleIconOn:se,toggleSvgIconOff:xe,toggleSvgIconOn:be,trashIcon:te,trashSvgIcon:function(){return Se(te())},userEditIcon:G,userEditSvgIcon:function(){return Se(G())},userIcon:W,userPlusCloseIcon:Y,userPlusCloseSvgIcon:fe,userPlusIcon:K,userPlusSvgIcon:ue,userSvgIcon:function(){return Se(W())}});function Ie(e){return` \n    <form id="familyForm" class="f3-form ${e.editable?"":"non-editable"}">\n      ${Le()}\n      <div style="text-align: right; display: 'block'">\n        ${e.no_edit?"":function(e){return`\n    <span class="f3-add-relative-btn">\n      ${e.addRelativeActive?fe():ue()}\n    </span>\n  `}(e)}\n        ${e.no_edit?'<div style="height: 24px;"></div>':function(e){return`\n    <span class="f3-edit-btn">\n      ${e.editable?me():_e()}\n    </span>\n  `}(e)}\n      </div>\n\n      ${Ae(e)}\n\n      ${Re(e)}\n      \n      <div class="f3-form-buttons">\n        <button type="button" class="f3-cancel-btn">Cancel</button>\n        <button type="submit">Submit</button>\n      </div>\n\n      ${e.linkExistingRelative?He(e):""}\n\n      <hr>\n      ${function(e){return`\n    <div>\n      <button type="button" class="f3-delete-btn" ${e.can_delete?"":"disabled"}>\n        Delete\n      </button>\n    </div>\n  `}(e)}\n\n      ${function(e){return`\n    <div>\n      <button type="button" class="f3-remove-relative-btn${e.removeRelativeActive?" active":""}">\n        ${e.removeRelativeActive?"Cancel Remove Relation":"Remove Relation"}\n      </button>\n    </div>\n  `}(e)}\n    </form>\n  `}function Ae(e){return e.editable?`\n    <div class="f3-radio-group">\n      ${e.gender_field.options.map(t=>`\n        <label>\n          <input type="radio" name="${e.gender_field.id}" \n            value="${t.value}" \n            ${t.value===e.gender_field.initial_value?"checked":""}\n            ${e.gender_field.disabled?"disabled":""}\n          >\n          ${t.label}\n        </label>\n      `).join("")}\n    </div>\n  `:""}function Re(e){if(!e.editable)return function(){let t="";return e.fields.forEach(e=>{var n;if("rel_reference"===e.type){if(!e.initial_value)return;t+=`\n        <div class="f3-info-field">\n          <span class="f3-info-field-label">${e.label} - <i>${e.rel_label}</i></span>\n          <span class="f3-info-field-value">${e.initial_value||""}</span>\n        </div>`}else if("select"===e.type){const i=e;if(!e.initial_value)return;t+=`\n        <div class="f3-info-field">\n          <span class="f3-info-field-label">${i.label}</span>\n          <span class="f3-info-field-value">${(null===(n=i.options.find(e=>e.value===i.initial_value))||void 0===n?void 0:n.label)||""}</span>\n        </div>`}else t+=`\n        <div class="f3-info-field">\n          <span class="f3-info-field-label">${e.label}</span>\n          <span class="f3-info-field-value">${e.initial_value||""}</span>\n        </div>`}),t}();let t="";return e.fields.forEach(e=>{if("text"===e.type)t+=`\n      <div class="f3-form-field">\n        <label>${e.label}</label>\n        <input type="${e.type}" \n          name="${e.id}" \n          value="${e.initial_value||""}"\n          placeholder="${e.label}">\n      </div>`;else if("textarea"===e.type)t+=`\n      <div class="f3-form-field">\n        <label>${e.label}</label>\n        <textarea name="${e.id}" \n          placeholder="${e.label}">${e.initial_value||""}</textarea>\n      </div>`;else if("select"===e.type){const n=e;t+=`\n      <div class="f3-form-field">\n        <label>${n.label}</label>\n        <select name="${n.id}" value="${n.initial_value||""}">\n          <option value="">${n.placeholder||`Select ${n.label}`}</option>\n          ${n.options.map(e=>`<option ${e.value===n.initial_value?"selected":""} value="${e.value}">${e.label}</option>`).join("")}\n        </select>\n      </div>`}else"rel_reference"===e.type&&(t+=`\n      <div class="f3-form-field">\n        <label>${e.label} - <i>${e.rel_label}</i></label>\n        <input type="text" \n          name="${e.id}" \n          value="${e.initial_value||""}"\n          placeholder="${e.label}">\n      </div>`)}),t}function He(e){return`\n    <div>\n      <hr>\n      <div class="f3-link-existing-relative">\n        <label>${e.linkExistingRelative.hasOwnProperty("title")?e.linkExistingRelative.title:"Profile already exists?"}</label>\n        <select>\n          <option value="">${e.linkExistingRelative.hasOwnProperty("select_placeholder")?e.linkExistingRelative.select_placeholder:"Select profile"}</option>\n          ${e.linkExistingRelative.options.map(e=>`<option value="${e.value}">${e.label}</option>`).join("")}\n        </select>\n      </div>\n    </div>\n  `}function Le(){return'\n    <span class="f3-close-btn">\n      ×\n    </span>\n  '}function De(e,t){return Oe(e,t)}function Fe(e,t){return Oe(e,t)}function Oe(e,t){const n=function(e){return"new_rel"in e}(e),i=document.createElement("div");return function r(){const a=n?function(e){return` \n    <form id="familyForm" class="f3-form">\n      \n    <span class="f3-close-btn">\n      ×\n    </span>\n  \n      <h3 class="f3-form-title">${e.title}</h3>\n      ${Ae(e)}\n\n      ${Re(e)}\n      \n      <div class="f3-form-buttons">\n        <button type="button" class="f3-cancel-btn">Cancel</button>\n        <button type="submit">Submit</button>\n      </div>\n\n      ${e.linkExistingRelative?He(e):""}\n    </form>\n  `}(e):Ie(e);i.innerHTML=a,function(e,t,n,i){const r=e.querySelector("form");r.addEventListener("submit",t.onSubmit);r.querySelector(".f3-cancel-btn").addEventListener("click",a);function a(){t.editable=!1,t.onCancel&&t.onCancel(),i()}r.querySelector(".f3-close-btn").addEventListener("click",n)}(i,e,t,r),n?function(e,t){const n=e.querySelector("form"),i=n.querySelector(".f3-link-existing-relative select");i&&i.addEventListener("change",t.linkExistingRelative.onSelect)}(i,e):function(e,t,n){const i=e.querySelector("form"),r=i.querySelector(".f3-edit-btn");r&&r.addEventListener("click",d);const a=i.querySelector(".f3-delete-btn");a&&t.onDelete&&a.addEventListener("click",t.onDelete);const s=i.querySelector(".f3-add-relative-btn");s&&t.addRelative&&s.addEventListener("click",()=>{t.addRelativeActive?t.addRelativeCancel():t.addRelative(),t.addRelativeActive=!t.addRelativeActive,n()});const o=i.querySelector(".f3-remove-relative-btn");o&&t.removeRelative&&o.addEventListener("click",()=>{t.removeRelativeActive?t.removeRelativeCancel():t.removeRelative(),t.removeRelativeActive=!t.removeRelativeActive,n()});const l=i.querySelector(".f3-link-existing-relative select");l&&l.addEventListener("change",t.linkExistingRelative.onSelect);function d(){t.editable=!t.editable,n()}}(i,e,r);e.onFormCreation&&e.onFormCreation({cont:i,form_creator:e})}(),i}function Te(e,t,n){let i=[],r=-1;return{changed:function(){r<i.length-1&&(i=i.slice(0,r+1));const n=t();n.main_id=e.getMainId(),i.push(n),r++},back:function(){if(!s())return;r--,o(i[r])},forward:function(){if(!a())return;r++,o(i[r])},canForward:a,canBack:s};function a(){return r<i.length-1}function s(){return r>0}function o(t){const i=e.getMainId();(t=JSON.parse(JSON.stringify(t))).find(e=>e.id===i)||e.updateMainId(t.main_id),e.updateData(t),n()}}function Pe(e,t){const n=i.select(e).append("div").attr("class","f3-history-controls");e.insertBefore(n.node(),e.firstChild);const r=n.append("button").attr("class","f3-back-button").on("click",()=>{t.back(),s()}),a=n.append("button").attr("class","f3-forward-button").on("click",()=>{t.forward(),s()});return r.html(ge()),a.html(ve()),{back_btn:r.node(),forward_btn:a.node(),updateButtons:s,destroy:function(){i.select(e).select(".f3-history-controls").remove()}};function s(){r.classed("disabled",!t.canBack()),a.classed("disabled",!t.canForward()),t.canBack()||t.canForward()?n.style("opacity",1).style("pointer-events","auto"):n.style("opacity",0).style("pointer-events","none")}}var qe=Object.freeze({__proto__:null,addNewPerson:function({data_stash:e,datum:t}){e.push(t)},calculateDelay:h,calculateTreeFit:y,cardChangeMain:T,cardComponentSetup:function(e){const t=()=>e.querySelector("#htmlSvg");return M(e,{onZoom:R(()=>e.querySelector("svg .view"),()=>e.querySelector("#htmlSvg .cards_view"))}),i.select(t()).append("div").attr("class","cards_view_fake").style("display","none"),L(t)},cardShowHideRels:P,cardToMiddle:w,checkIfConnectedToFirstPerson:j,checkIfRelativesConnectedWithoutPerson:q,cleanupDataJson:Z,createFormEdit:Fe,createFormNew:De,createHistory:Te,createHistoryControls:Pe,createNewPerson:d,createNewPersonWithGenderFromRel:function({data:e,rel_type:t,rel_datum:n}){const i=function(e,t){return["daughter","mother"].includes(t)||"spouse"===t&&"M"===e.data.gender?"F":"M"}(n,t);return d({data:e=Object.assign(e||{},{gender:i})})},deletePerson:B,getCurrentZoom:x,htmlContSetup:I,isAllRelativeDisplayed:c,manualZoom:b,moveToAddToAdded:function(e,t){return delete e.to_add,e},onDeleteSyncRelReference:N,removeToAdd:U,removeToAddFromData:J,setupZoom:k,submitFormData:z,syncRelReference:V,treeFit:v,zoomTo:C});function je({d:e,card_dim:t,card_display:n}){return{template:`\n    <g class="card-body">\n      <rect width="${t.w}" height="${t.h}" class="card-body-rect" />\n      ${ze({d:e,card_dim:t,card_display:n}).template}\n    </g>\n  `}}function ze({d:e,card_dim:t,card_display:n}){return{template:`\n    <g>\n      <g class="card-text" clip-path="url(#card_text_clip)">\n        <g transform="translate(${t.text_x}, ${t.text_y})">\n          <text>\n            ${Array.isArray(n)?n.map(t=>`<tspan x="0" dy="14">${t(e.data)}</tspan>`).join("\n"):n(e.data)}\n          </text>\n        </g>\n      </g>\n      <rect width="${t.w-10}" height="${t.h}" style="mask: url(#fade)" class="text-overflow-mask" /> \n    </g>\n  `}}function Ve({d:e,card_dim:t,is_new:n}){return{template:`\n    <rect width="${t.w}" height="${t.h}" rx="4" ry="4" class="card-outline ${e.data.main&&!n?"card-main-outline":""} ${n?"card-new-outline":""}" />\n  `}}function Ne({x:e,y:t,rt:n,closed:i}){return{template:`\n    <g style="\n          transform: translate(-12.2px, -.5px);\n          cursor: pointer;\n        " \n        fill="currentColor" class="card_break_link${i?" closed":""}"\n      >\n      <g style="transform: translate(${e}px,${t}px)scale(.02)rotate(${n+"deg"})">\n        <rect width="1000" height="700" y="150" style="opacity: 0" />\n        <g class="link_upper">\n          <g>\n            <path d="M616.3,426.4c19,4.5,38.1-7.4,42.6-26.4c4.4-19-7.4-38-26.5-42.5L522.5,332c-18,11.1-53.9,33.4-53.9,33.4l80.4,18.6c-7.8,4.9-19.5,12.1-31.3,19.4L616.3,426.4L616.3,426.4z"/>\n            <path d="M727.4,244.2c-50.2-11.6-100.3,3.3-135.7,35.4c28.6,22.6,64.5,30.2,116.4,51.3l141,32.6c23.9,5.6,56.6,47.2,51.1,71l-4.1,17c-5.6,23.7-47.3,56.4-71.2,51l-143.4-33.2c-66.8-8.6-104.1-16.6-132.9-7.5c17.4,44.9,55.9,80.8,106.5,92.4L800.9,588c81.3,18.8,162.3-31.5,181.2-112.4l4-17c18.8-81.1-31.7-161.8-112.9-180.6L727.4,244.2z"/>\n          </g>\n        </g>\n        <g class="link_lower">\n          <path d="M421.2,384.9l-128,127.6c-13.9,13.8-13.9,36.2,0,50s36.3,13.8,50.2,0.1l136.2-135.8v-36.7l-58.4,58.1V384.9L421.2,384.9z"/>\n          <path d="M204.6,742.8c-17.4,17.3-63.3,17.2-80.6,0.1l-12.3-12.3c-17.3-17.3,0.6-81.2,17.9-98.5l100.2-99.9c12.5-14.9,45.8-40.8,66.1-103.7c-47.7-9.4-98.9,4.2-135.8,40.9L54.2,575c-58.9,58.8-58.9,154,0,212.8L66.6,800c58.9,58.8,154.5,58.8,213.4,0l105.8-105.6c38.4-38.3,51.3-91.9,39.7-141c-44,22.7-89,62.3-116,84.8L204.6,742.8z"/>\n        </g>\n        <g class="link_particles">\n          <path d="M351.9,248.4l-26.5,63.4l80.6,30.1L351.9,248.4z"/>\n          <path d="M529.3,208l-43,26.6l35.4,52.3L529.3,208z"/>\n          <path d="M426.6,158.8l-44-2.9l61.7,134.6L426.6,158.8z"/>\n        </g>\n      </g>\n    </g>\n  `}}function Ue(e,t,n){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=e,n?t.insertBefore(i,t.firstChild):t.appendChild(i)}const Be={miniTree:function(e,t){if(e.data.to_add)return;const n=t.card_dim;if(e.all_rels_displayed)return;const r=i.create("svg:g").html(function({d:e,card_dim:t}){return{template:`\n    <g class="card_family_tree" style="cursor: pointer">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g transform="translate(${.8*t.w},6)scale(.9)">\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  `}}({d:e,card_dim:n}).template);return r.on("click",function(n){n.stopPropagation(),t.onMiniTreeClick?t.onMiniTreeClick.call(this,n,e):T(t.store,{d:e})}),r.node()},lineBreak:function(e,t){if(e.data.to_add)return;const n=t.card_dim,r=i.create("svg:g").html(function({d:e,card_dim:t}){let n="",i=e.data.rels,r=e.data._rels||{},a=e.data.hide_rels,s=e=>e.father||e.mother,o=e=>e.children&&e.children.length>0;if((e.is_ancestry||e.data.main)&&(s(i)||s(r))&&(n+=Ne({x:t.w/2,y:0,rt:-45,closed:a}).template),!e.is_ancestry&&e.added){const s=e.spouse,l=s.data.rels,d=s.data._rels||{};(o(i)||o(r))&&(o(l)||o(d))&&(n+=Ne({x:e.sx-e.x+t.w/2+24.4,y:(e.x!==e.sx?t.h/2:t.h)+1,rt:135,closed:a}).template)}return{template:n}}({d:e,card_dim:n}).template);return r.on("click",n=>{n.stopPropagation(),P(t.store,{d:e})}),r.node()},cardBody:function(e,t){const n=t.card_dim,r=i.create("svg:g").html(je({d:e,card_dim:n,card_display:t.card_display}).template);return r.on("click",function(n){n.stopPropagation(),t.onCardClick?t.onCardClick.call(this,n,e):T(t.store,{d:e})}),r.node()},cardImage:function(e,t){if(e.data.to_add)return;const n=t.card_dim;return i.create("svg:g").html(function({d:e,image:t,card_dim:n,maleIcon:i,femaleIcon:r}){return{template:`\n    <g style="transform: translate(${n.img_x}px,${n.img_y}px);" class="card_image" clip-path="url(#card_image_clip)">\n      ${t?`<image href="${t}" height="${n.img_h}" width="${n.img_w}" preserveAspectRatio="xMidYMin slice" />`:(e.data.data.gender,e.data.data.gender,`\n      <g class="genderless-icon">\n        <rect height="${n.img_h}" width="${n.img_w}" fill="rgb(59, 85, 96)" />\n        <g transform="scale(${.001616*n.img_w})">\n         <path transform="translate(50,40)" fill="lightgrey" d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n            64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n            0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n        </g>\n      </g>\n    `)}      \n    </g>\n  `}}({d:e,image:e.data.data.avatar||null,card_dim:n,maleIcon:void 0,femaleIcon:void 0}).template).node()}};function Ze(e,t,n=!1){e&&(n?t.insertBefore(e,t.firstChild):t.appendChild(e))}function Je(e){const t="default"===e.style?a:"imageCircleRect"===e.style?function(t){return t.data.data[e.cardImageField]?s(t):o(t)}:"imageCircle"===e.style?s:"imageRect"===e.style?function(e){return n(e)}:"rect"===e.style?o:a;return function(n){if(this.innerHTML=`\n    <div class="card ${function(e){const t=[];"M"===e.data.data.gender?t.push("card-male"):"F"===e.data.data.gender?t.push("card-female"):t.push("card-genderless");t.push(`card-depth-${e.is_ancestry?-e.depth:e.depth}`),e.data.main&&t.push("card-main");e.data._new_rel_data&&t.push("card-new-rel");e.data.to_add&&t.push("card-to-add");e.data.unknown&&t.push("card-unknown");return t}(n).join(" ")}" data-id="${n.tid}" style="transform: translate(-50%, -50%); pointer-events: auto;">\n      ${e.mini_tree?function(t){return e.mini_tree?t.data.to_add||t.data._new_rel_data||t.all_rels_displayed?"":`<div class="mini-tree">${we()}</div>`:""}(n):""}\n      ${e.cardInnerHtmlCreator&&!n.data._new_rel_data?e.cardInnerHtmlCreator(n):t(n)}\n    </div>\n    `,this.querySelector(".card").addEventListener("click",t=>e.onCardClick(t,n)),e.onCardUpdate&&e.onCardUpdate.call(this,n),e.onCardMouseenter&&i.select(this).select(".card").on("mouseenter",t=>e.onCardMouseenter(t,n)),e.onCardMouseleave&&i.select(this).select(".card").on("mouseleave",t=>e.onCardMouseleave(t,n)),n.duplicate&&function(e,t){i.select(e).on("mouseenter",n=>{i.select(e.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",e=>e.data.id===t.data.id)}),i.select(e).on("mouseleave",t=>{i.select(e.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",!1)})}(this,n),e.duplicate_branch_toggle&&function(e,t,n,r){if(!t.hasOwnProperty("_toggle"))return;const a=e.querySelector(".card"),s=a.querySelector(".card-inner"),o=e.querySelector(".card").offsetWidth;let l,d;e.querySelector(".card").offsetHeight;const c={};if(t.spouse){const e=t.spouse,i=e.data.main?"main":e.parent.data.id;if(l=e.data._tgdp_sp[i][t.data.id]<0,c.top=60,c.left=t.sx-t.x-30+o/2,n&&(c.top=t.sy-t.x+4,c.left=o/2+4,Math.abs(t.sx-t.y)<10&&(c.left=o-4)),d=e._toggle_id_sp?e._toggle_id_sp[t.data.id]:-1,-1===d)return}else{const e=t.data.main?"main":t.parent.data.id;l=t.data._tgdp[e]<0,c.top=-65,c.left=o/2-30,n&&(c.top=5,c.left=-55),d=t._toggle_id}if(s.style.zIndex=1,i.select(a).append("div").attr("class","f3-toggle-div").attr("style","cursor: pointer; width: 60px; height: 60px;position: absolute; z-index: -1;").style("top",c.top+"px").style("left",c.left+"px").on("click",e=>{if(e.stopPropagation(),t.spouse){const e=t.spouse,n=e.data.main?"main":e.parent.data.id;e.data._tgdp_sp[n].hasOwnProperty(t.data.id)||console.error("no toggle",t,e);let i=e.data._tgdp_sp[n][t.data.id];i=i<0?(new Date).getTime():-(new Date).getTime(),e.data._tgdp_sp[n][t.data.id]=i}else{const e=t.data.main?"main":t.parent.data.id;let n=t.data._tgdp[e];n=n<0?(new Date).getTime():-(new Date).getTime(),t.data._tgdp[e]=n}r()}).append("div").html(l?xe():be()).select("svg").classed("f3-toggle-icon",!0).style("color",l?"#585656":"#61bf52").style("padding","0"),i.select(a).select(".f3-toggle-icon .f3-small-circle").style("fill","#fff"),i.select(a).select(".f3-toggle-icon").append("text").attr("transform",l?"translate(10.6, 14.5)":"translate(4.1, 14.5)").attr("fill","#fff").attr("font-size","7px").text("C"+d),l){let e;e=t.is_ancestry?n?"translate(5, -30)rotate(-90)":"translate(0, -10)":n?"translate(11, -22)rotate(90)":"translate(-7, -32)rotate(180)",i.select(a).select(".f3-toggle-div").insert("div").html(we()).select("svg").attr("style","position: absolute; z-index: -1;top: 0;left: 0;border-radius: 0;").style("width","66px").style("height","112px").attr("transform",e).attr("viewBox","0 0 72 125").select("line").attr("y1",t.is_ancestry?"62":"92")}}(this,n,e.store.state.is_horizontal,e.store.updateTree),location.origin.includes("localhost")&&(n.__node=this.querySelector(".card"),n.__label=n.data.data["first name"],n.data.to_add)){const e=n.spouse||n.coparent||null;e&&i.select(this).select(".card").attr("data-to-add",e.data.data["first name"])}};function n(t){return`\n    <div class="card-inner card-image-rect" ${l()}>\n      ${t.data.data[e.cardImageField]?`<img src="${t.data.data[e.cardImageField]}" ${d()}>`:c(t)}\n      <div class="card-label">${r(t)}</div>\n      ${t.duplicate?h(t):""}\n    </div>\n    `}function r(t){return t.data._new_rel_data?function(e){const t=[];t.push(`data-rel-type="${e.data._new_rel_data.rel_type}"`),["son","daughter"].includes(e.data._new_rel_data.rel_type)&&t.push(`data-other-parent-id="${e.data._new_rel_data.other_parent_id}"`);return`<div ${t.join(" ")}>${e.data._new_rel_data.label}</div>`}(t):t.data.to_add?`<div>${e.empty_card_label||"ADD"}</div>`:t.data.unknown?`<div>${e.unknown_card_label||"UNKNOWN"}</div>`:`\n      ${e.card_display.map(e=>`<div>${e(t.data)}</div>`).join("")}\n    `}function a(e){return n(e)}function s(t){return function(t){return`\n    <div class="card-inner card-image-circle" ${l()}>\n      ${t.data.data[e.cardImageField]?`<img src="${t.data.data[e.cardImageField]}" ${d()}>`:c(t)}\n      <div class="card-label">${r(t)}</div>\n      ${t.duplicate?h(t):""}\n    </div>\n    `}(t)}function o(e){return function(e){return`\n    <div class="card-inner card-rect" ${l()}>\n      ${r(e)}\n      ${e.duplicate?h(e):""}\n    </div>\n    `}(e)}function l(){let t='style="';return e.card_dim.w||e.card_dim.h?(t+=`width: ${e.card_dim.w}px; min-height: ${e.card_dim.h}px;`,e.card_dim.height_auto?t+="height: auto;":t+=`height: ${e.card_dim.h}px;`,t+='"',t):""}function d(){let t='style="position: relative;';return e.card_dim.img_w||e.card_dim.img_h||e.card_dim.img_x||e.card_dim.img_y?(t+=`width: ${e.card_dim.img_w}px; height: ${e.card_dim.img_h}px;`,t+=`left: ${e.card_dim.img_x}px; top: ${e.card_dim.img_y}px;`,t+='"',t):""}function c(t){return t.data._new_rel_data?`<div class="person-icon" ${d()}>${pe()}</div>`:`<div class="person-icon" ${d()}>${e.defaultPersonIcon?e.defaultPersonIcon(t):ye()}</div>`}function h(e){return`<div class="f3-card-duplicate-tag">x${e.duplicate}</div>`}}function We(e,t){function n(e,t,n){const{w:i,h:r}=e,a=t,s=n||[],o=e=>s.includes(e);return`${o("lx")?"M0,0":`M0,${a} Q 0,0 5,0`} ${o("rx")?`H${i}`:`H${i-a} Q ${i},0 ${i},5`} ${o("ry")?`V${r}`:`V${r-a} Q ${i},${r} ${i-a},${r}`} ${o("ly")?"H0":`H${a} Q 0,${r} 0,${r-a}`} z`}e.querySelector("defs#f3CardDef")||e.insertAdjacentHTML("afterbegin",`\n      <defs id="f3CardDef">\n        <linearGradient id="fadeGrad">\n          <stop offset="0.9" stop-color="white" stop-opacity="0"/>\n          <stop offset=".91" stop-color="white" stop-opacity=".5"/>\n          <stop offset="1" stop-color="white" stop-opacity="1"/>\n        </linearGradient>\n        <mask id="fade" maskContentUnits="objectBoundingBox"><rect width="1" height="1" fill="url(#fadeGrad)"/></mask>\n        <clipPath id="card_clip"><path d="${n({w:t.w,h:t.h},5)}"></clipPath>\n        <clipPath id="card_text_clip"><rect width="${t.w-10}" height="${t.h}"></rect></clipPath>\n        <clipPath id="card_image_clip"><path d="M0,0 Q 0,0 0,0 H${t.img_w} V${t.img_h} H0 Q 0,${t.img_h} 0,${t.img_h} z"></clipPath>\n        <clipPath id="card_image_clip_curved"><path d="${n({w:t.img_w,h:t.img_h},5,["rx","ry"])}"></clipPath>\n      </defs>\n    `)}function Ge(e){return We((e=function(e){const t={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};e||(e={});for(const n in t)void 0===e[n]&&(e[n]=t[n]);return e}(e)).svg,e.card_dim),function(t){const n="M"===t.data.data.gender?"card-male":"F"===t.data.data.gender?"card-female":"card-genderless",r=e.card_dim,a=i.create("svg:g").attr("class",`card ${n}`).attr("transform",`translate(${[-r.w/2,-r.h/2]})`);a.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(a.node()),a.on("click",function(n){n.stopPropagation(),e.onCardClick.call(this,n,t)}),t.data._new_rel_data?(Ue(Ve({d:t,card_dim:r,is_new:t.data.to_add}).template,a.node(),!0),Ue(function({d:e,card_dim:t,label:n}){return{template:`\n    <g class="card-body">\n      <rect class="card-body-rect" width="${t.w}" height="${t.h}" />\n      <text transform="translate(${t.img_w+5}, ${t.h/2})">\n        <tspan font-size="18" dy="8" pointer-events="none">${n}</tspan>\n      </text>\n    </g>\n  `}}({d:t,card_dim:r,label:t.data._new_rel_data.label}).template,this.querySelector(".card-inner"),!0),i.select(this.querySelector(".card-inner")).append("g").attr("class","card-edit-icon").attr("fill","currentColor").attr("transform",`translate(-1,2)scale(${r.img_h/22})`).html(Q())):(Ue(Ve({d:t,card_dim:r,is_new:t.data.to_add}).template,a.node(),!0),Ue(je({d:t,card_dim:r,card_display:e.card_display}).template,this.querySelector(".card-inner"),!1),e.img&&Ze(Be.cardImage(t,e),this.querySelector(".card")),e.mini_tree&&Ze(Be.miniTree(t,e),this.querySelector(".card"),!0),e.link_break&&Ze(Be.lineBreak(t,e),this.querySelector(".card"))),e.onCardUpdate&&e.onCardUpdate.call(this,t)}}function Ke(e){return void 0===e.onCardClick&&(e.onCardClick=(t,n)=>{e.store.updateMainId(n.data.id),e.store.updateTree({})}),Ge(e)}function Ye(e,t){return new Qe(e,t)}class Qe{constructor(e,t){this.cont=e,this.active=!1,this.onClose=t,this.popup_cont=i.select(this.cont).append("div").attr("class","f3-popup").node(),this.create()}create(){const e=i.select(this.popup_cont);e.html('\n      <div class="f3-popup-content">\n        <span class="f3-popup-close">&times;</span>\n        <div class="f3-popup-content-inner"></div>\n      </div>\n    '),e.select(".f3-popup-close").on("click",()=>{this.close()}),e.on("click",t=>{t.target==e.node()&&this.close()})}activate(e){const t=i.select(this.popup_cont).select(".f3-popup-content-inner").node();e&&t.appendChild(e),this.open()}open(){this.active=!0}close(){this.popup_cont.remove(),this.active=!1,this.onClose&&this.onClose()}}function Xe(e,t,n){const i=t.find(t=>t.id===e),r={};return function e(n,i,a,s){if(!n)return;if(r[n])return;i&&(r[n]=i);const o=t.find(e=>e.id===n),l=o.rels;if("self"===i)e(l.father,"parent",a-1,n),e(l.mother,"parent",a-1,n),(l.spouses||[]).forEach(t=>e(t,"spouse",a)),(l.children||[]).forEach(t=>e(t,"child",a+1));else if("parent"===i)e(l.father,"grandparent",a-1,n),e(l.mother,"grandparent",a-1,n),(l.children||[]).forEach(t=>{s&&s===t||e(t,"sibling",a+1)});else if("spouse"===i);else if("child"===i)(l.children||[]).forEach(t=>e(t,"grandchild",a+1));else if("sibling"===i)(l.children||[]).forEach(t=>e(t,"nephew",a+1));else if("grandparent"===i)s||console.error(`${i} should have prev_rel_id`),e(l.father,"great-grandparent",a-1,n),e(l.mother,"great-grandparent",a-1,n),(l.children||[]).forEach(t=>{s&&s===t||e(t,"uncle",a+1)});else if(i.includes("grandchild"))(l.children||[]).forEach(t=>e(t,it(i,a+1),a+1));else if(i.includes("great-grandparent"))s||console.error(`${i} should have prev_rel_id`),e(l.father,it(i,a-1),a-1,n),e(l.mother,it(i,a-1),a-1,n),(l.children||[]).forEach(t=>{if(s&&s===t)return;const n=nt(a+1);0===n?e(t,"granduncle",a+1):n>0?e(t,it("granduncle",a+1),a+1):console.error(`${i} should have great_count > -1`)});else if("nephew"===i)(l.children||[]).forEach(t=>e(t,"grandnephew",a+1));else if(i.includes("grandnephew"))(l.children||[]).forEach(t=>e(t,it(i,a+1),a+1));else if("uncle"===i)(l.children||[]).forEach(t=>e(t,"1st Cousin",a+1));else if("granduncle"===i)(l.children||[]).forEach(t=>e(t,"1st Cousin 1x removed",a+1));else if(i.includes("great-granduncle")){const t=a+1,n=Math.abs(t);(l.children||[]).forEach(i=>e(i,`1st Cousin ${n}x removed`,t))}else i.slice(4).startsWith("Cousin")?(l.children||[]).forEach(t=>{const n=a+1,r=Math.abs(n),s=+i[0];0===n?e(t,`${tt(s+1)} Cousin`,n):n<0?e(t,`${tt(s+1)} Cousin ${r}x removed`,n):n>0&&e(t,`${tt(s)} Cousin ${r}x removed`,n)}):console.error(`${i} not found`)}(i.id,"self",0),function(e){const n=[];Object.keys(e).forEach(r=>{const a=e[r];if(a.includes("child"))return;if("spouse"===a)return;const s=et(i.id,r,t);if(!s)return console.error(`${t.find(e=>e.id===r).data} not found in main_ancestry`);s.is_half_kin&&n.push(r)}),n.forEach(t=>{e[t]=`Half ${e[t]}`})}(r),n.show_in_law&&function(e,t){Object.keys(e).forEach(n=>{const i=e[n],r=t.find(e=>e.id===n);if("spouse"===i){const t=[];r.rels.mother&&(a(r.rels.mother).rels.children||[]).forEach(e=>t.push(e)),r.rels.father&&(a(r.rels.father).rels.children||[]).forEach(e=>t.push(e)),t.forEach(t=>{e[t]||(e[t]="sibling-in-law")})}"sibling"===i&&(r.rels.spouses||[]).forEach(t=>{e[t]||(e[t]="sibling-in-law")}),"child"===i&&(r.rels.spouses||[]).forEach(t=>{e[t]||(e[t]="child-in-law")}),"uncle"===i&&(r.rels.spouses||[]).forEach(t=>{e[t]||(e[t]="uncle-in-law")}),i.includes("Cousin")&&(r.rels.spouses||[]).forEach(t=>{e[t]||(e[t]=`${i} in-law`)})})}(r,t),function(e){Object.keys(e).forEach(n=>{const i=e[n],r=t.find(e=>e.id===n).data.gender;if(i.includes("parent")){const t="M"===r?"father":"F"===r?"mother":"parent";e[n]=e[n].replace("parent",t)}else if(i.includes("sibling")){const t="M"===r?"brother":"F"===r?"sister":"sibling";e[n]=e[n].replace("sibling",t)}else if(i.includes("child")){const t="M"===r?"son":"F"===r?"daughter":"child";e[n]=e[n].replace("child",t)}else if(i.includes("uncle")){const t="M"===r?"uncle":"F"===r?"aunt":"aunt/uncle";e[n]=e[n].replace("uncle",t)}else if(i.includes("nephew")){const t="M"===r?"nephew":"F"===r?"niece":"neice/nephew";e[n]=e[n].replace("nephew",t)}})}(r),r;function a(e){return t.find(t=>t.id===e)}}function et(e,t,n){const i=function(e){const t=[];return function e(i){const r=n.find(e=>e.id===i),a=r.rels;t.push(o(a)),a.father&&e(a.father);a.mother&&e(a.mother)}(e),t}(e);let r,a,s;return function(e){const t=n.find(t=>t.id===e);i.find(e=>e[0]===t.id||e[1]===t.id)&&(a=!0,r=e,s=!1)}(t),function(t){(n.find(t=>t.id===e).rels.spouses||[]).includes(t)&&(r=[e,t])}(t),function t(l){if(r)return;if(l===e)return a=!0,r=l,void(s=!1);const d=n.find(e=>e.id===l),c=d.rels,h=o(c),u=i.find(e=>e[0]&&h[0]&&e[0]===h[0]||e[1]&&h[1]&&e[1]===h[1]);if(u)return r=h.filter((e,t)=>e===u[t]),p=u,void(s=(f=h)[0]!==p[0]||f[1]!==p[1]);var f,p;c.father&&t(c.father);c.mother&&t(c.mother)}(t),r?{found:r,is_ancestor:a,is_half_kin:s}:null;function o(e){return[e.father,e.mother]}}function tt(e){const t=["st","nd","rd"];return t[e-1]?e+t[e-1]:e+"th"}function nt(e){return Math.abs(e)-2}function it(e,t){const n=nt(t);return e.includes("great-")&&(e=e.split("great-")[1]),1===n?`great-${e}`:n>1?`${n}x-great-${e}`:(console.error(`${e} should have great_count > 1`),e)}function rt(e,t,n,r){var a;let s;const o=r[t].toLowerCase();if(o.includes("in-law")){s=t;const i=n.find(e=>e.id===s);t=o.includes("sister")||o.includes("brother")?e:null===(a=i.rels.spouses)||void 0===a?void 0:a.find(e=>r[e]&&!r[e].includes("in-law"))}const l=et(e,t,n);if(!l)return console.error(`${t} not found in main_ancestry`);const d=l.is_ancestor?l.found:l.found[0],c=n.find(e=>e.id===d),h=i.hierarchy(c,function(e){return[...e.rels.children||[]].map(e=>n.find(t=>t.id===e)).filter(e=>e)}),u=h.descendants().map(e=>e.data.id),f=m(e,u),p=m(t,u);!function e(t){t.children=(t.children||[]).filter(e=>!!f.includes(e.data.id)||!!p.includes(e.data.id)),t.children.forEach(t=>e(t)),0===t.children.length&&delete t.children}(h);const _=h.descendants().map(e=>{const t={id:e.data.id,data:JSON.parse(JSON.stringify(e.data.data)),kinship:r[e.data.id],rels:{spouses:[],children:[]}};return e.children&&e.children.length>0&&(t.rels.children=e.children.map(e=>e.data.id)),t});return _.length>0&&!l.is_ancestor&&!l.is_half_kin&&function(e){const i=e[0];if(!l)return console.error(`${t} not found in main_ancestry`);const a=d===l.found[0]?l.found[1]:l.found[0];i.rels.spouses=[a];const s=n.find(e=>e.id===a),o={id:s.id,data:JSON.parse(JSON.stringify(s.data)),kinship:r[s.id],rels:{spouses:[i.id],children:i.rels.children}};e.push(o),(i.rels.children||[]).forEach(t=>{const i=n.find(e=>e.id===t),r=e.find(e=>e.id===t);r.rels.father=i.rels.father,r.rels.mother=i.rels.mother})}(_),s&&function(e){o.includes("sister")||o.includes("brother")?function(e){var n;const i=e.find(e=>e.id===t),a=g(s);e.push({id:s,data:JSON.parse(JSON.stringify(a.data)),kinship:r[s],rels:{spouses:[],children:[]}});const o=[];a.rels.mother&&(g(a.rels.mother).rels.children||[]).forEach(e=>o.push(e));a.rels.father&&(g(a.rels.father).rels.children||[]).forEach(e=>o.push(e));const l=null===(n=g(t).rels.spouses)||void 0===n?void 0:n.find(e=>o.includes(e));i.rels.spouses=[l];const d=g(l),c={id:d.id,data:JSON.parse(JSON.stringify(d.data)),kinship:r[d.id],rels:{spouses:[i.id],children:[]}};if(e.push(c),a.rels.father){const t=g(a.rels.father),n={id:t.id,data:JSON.parse(JSON.stringify(t.data)),kinship:"Father-in-law",rels:{spouses:[],children:[l,s]}};a.rels.mother&&n.rels.spouses.push(a.rels.mother),e.unshift(n)}if(a.rels.mother){const t=g(a.rels.mother),n={id:t.id,data:JSON.parse(JSON.stringify(t.data)),kinship:"Mother-in-law",rels:{spouses:[],children:[l,s]}};a.rels.father&&n.rels.spouses.push(a.rels.father),e.unshift(n)}}(e):function(e){const i=e.find(e=>e.id===t),a=s;i.rels.spouses=[a];const o=n.find(e=>e.id===a),l={id:o.id,data:JSON.parse(JSON.stringify(o.data)),kinship:r[o.id],rels:{spouses:[i.id],children:[]}};e.push(l)}(e)}(_),_;function m(e,t){const i=[e];return function e(r){const a=n.find(e=>e.id===r),s=a.rels;t.includes(s.mother)&&(i.push(s.mother),e(s.mother));t.includes(s.father)&&(i.push(s.father),e(s.father))}(e),i}function g(e){return n.find(t=>t.id===e)}}function at(e,t,n){const i=e.id;n.forEach(e=>{e.rels.father===i&&(e.rels.father=t),e.rels.mother===i&&(e.rels.mother=t),e.rels.spouses&&e.rels.spouses.includes(i)&&(e.rels.spouses=e.rels.spouses.filter(e=>e!==i),e.rels.spouses.includes(t)||e.rels.spouses.push(t)),e.rels.children&&e.rels.children.includes(i)&&(e.rels.children=e.rels.children.filter(e=>e!==i),e.rels.children.includes(t)||e.rels.children.push(t))});const r=n.find(e=>e.id===t),a=n.find(e=>e.id===i);if(!a)throw new Error("New rel not found");if(!r)throw new Error("Link rel not found");(a.rels.children||[]).forEach(e=>{r.rels.children||(r.rels.children=[]),r.rels.children.includes(e)||r.rels.children.push(e)}),(a.rels.spouses||[]).forEach(e=>{r.rels.spouses||(r.rels.spouses=[]),r.rels.spouses.includes(e)||r.rels.spouses.push(e)}),r.rels.father&&a.rels.father&&console.error("link rel already has father"),r.rels.mother&&a.rels.mother&&console.error("link rel already has mother"),a.rels.father&&(r.rels.father=a.rels.father),a.rels.mother&&(r.rels.mother=a.rels.mother),n.splice(n.findIndex(e=>e.id===i),1)}function st(e,t){const n=e._new_rel_data?t.find(t=>t.id===e._new_rel_data.rel_id):null,i=function(e,t){const n=[];return i(e),n;function i(e){[e.rels.father,e.rels.mother].forEach(e=>{if(e){n.push(e);const r=t.find(t=>t.id===e);if(!r)throw new Error("Parent not found");i(r)}})}}(e,t),r=a(e,t);if(e._new_rel_data&&["son","daughter"].includes(e._new_rel_data.rel_type)){if(!n)throw new Error("Rel datum not found");r.push(...a(n,t))}return t.filter(t=>t.id!==e.id&&t.id!==(null==n?void 0:n.id)&&!t._new_rel_data&&!t.to_add&&!t.unknown).filter(e=>!i.includes(e.id)).filter(e=>!r.includes(e.id)).filter(t=>!(t.rels.spouses||[]).includes(e.id));function a(e,t){const n=[];return function e(i){(i.rels.children?[...i.rels.children]:[]).forEach(i=>{n.push(i);const r=t.find(e=>e.id===i);if(!r)throw new Error("Child not found");e(r)})}(e),n}}function ot({datum:e,store:t,fields:n,postSubmitHandler:i,addRelative:r,removeRelative:a,deletePerson:s,onCancel:o,editFirst:l,link_existing_rel_config:d,onFormCreation:c,no_edit:h,onSubmit:u,onDelete:f,canEdit:p,canDelete:_}){let m=!_||_(e);let g;!p||p(e)||(h=!0,m=!1);const v={datum_id:e.id,fields:[],onSubmit:function(n){u?u(n,e,r,()=>i({})):(n.preventDefault(),r(),i({}));function r(){const i=new FormData(n.target);z(e,t.getData(),i)}},onCancel:o,onFormCreation:c,no_edit:h,gender_field:{id:"gender",type:"switch",label:"Gender",initial_value:e.data.gender,disabled:["father","mother"].some(t=>{var n;return t===(null===(n=e._new_rel_data)||void 0===n?void 0:n.rel_type)})||(e.rels.children||[]).some(e=>{const n=t.getDatum(e);return!n._new_rel_data}),options:[{value:"M",label:"Male"},{value:"F",label:"Female"}]}};if(e._new_rel_data)g=Object.assign(Object.assign({},v),{title:e._new_rel_data.label,new_rel:!0,editable:!0});else{if(!r)throw new Error("addRelative is required");if(!a)throw new Error("removeRelative is required");g=Object.assign(Object.assign({},v),{onDelete:function(){f?f(e,()=>s(),()=>i({delete:!0})):(s(),i({delete:!0}))},addRelative:()=>r.activate(e),addRelativeCancel:()=>r.onCancel(),addRelativeActive:r.is_active,removeRelative:()=>a.activate(e),removeRelativeCancel:()=>a.onCancel(),removeRelativeActive:a.is_active,editable:!1,can_delete:m})}return(e._new_rel_data||e.to_add||e.unknown)&&d&&(g.linkExistingRelative=function(e,t,n){if(!n)throw new Error("link_existing_rel_config is required");const i={title:n.title,select_placeholder:n.select_placeholder,options:st(e,t).map(e=>({value:e.id,label:n.linkRelLabel(e)})).sort((e,t)=>"string"==typeof e.label&&"string"==typeof t.label?e.label.localeCompare(t.label):e.label<t.label?-1:1),onSelect:y};return i}(e,t.getData(),d)),h?g.editable=!1:l&&(g.editable=!0),n.forEach(n=>{"rel_reference"===n.type?function(n){n.getRelLabel||console.error("getRelLabel is not set");"spouse"===n.rel_type&&(e.rels.spouses||[]).forEach(i=>{const r=t.getDatum(i);if(!r)throw new Error("Spouse not found");const a=`${n.id}__ref__${i}`,s={id:a,type:"rel_reference",label:n.label,rel_id:i,rel_label:n.getRelLabel(r),initial_value:e.data[a],rel_type:n.rel_type};g.fields.push(s)})}(n):"select"===n.type?function(t){if(!t.options&&!t.optionCreator)return console.error("optionCreator or options is not set for field",t);const n={id:t.id,type:t.type,label:t.label,initial_value:e.data[t.id],placeholder:t.placeholder,options:t.options||t.optionCreator(e)};g.fields.push(n)}(n):g.fields.push({id:n.id,type:n.type,label:n.label,initial_value:e.data[n.id]})}),g;function y(e){const t=e.target.value;i({link_rel_id:t})}}class lt{constructor(e,t,n){return this.store=e,this.onActivate=t,this.cancelCallback=n,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this.addRelLabels=this.addRelLabelsDefault(),this}activate(e){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;const t=this.store;this.datum=e;let n=this.datum.data.gender;!function(e,t,n,i){let r={parent:!0,spouse:!0,child:!0};i&&(r=Object.assign(r,i(e))),e.rels.spouses||(e.rels.spouses=[]),e.rels.children||(e.rels.children=[]),r.parent&&function(){if(!e.rels.father){const i=d({data:{gender:"M"},rels:{children:[e.id]}});i._new_rel_data={rel_type:"father",label:n.father,rel_id:e.id},e.rels.father=i.id,t.push(i)}if(!e.rels.mother){const i=d({data:{gender:"F"},rels:{children:[e.id]}});i._new_rel_data={rel_type:"mother",label:n.mother,rel_id:e.id},e.rels.mother=i.id,t.push(i)}const i=t.find(t=>t.id===e.rels.mother),r=t.find(t=>t.id===e.rels.father);i.rels.spouses||(i.rels.spouses=[]),r.rels.spouses||(r.rels.spouses=[]),i.rels.spouses.includes(r.id)||i.rels.spouses.push(r.id),r.rels.spouses.includes(i.id)||r.rels.spouses.push(i.id),i.rels.children||(i.rels.children=[]),r.rels.children||(r.rels.children=[]),i.rels.children.includes(e.id)||i.rels.children.push(e.id),r.rels.children.includes(e.id)||r.rels.children.push(e.id)}(),r.spouse&&(function(){if(e.rels.spouses||(e.rels.spouses=[]),e.rels.children){let i;e.rels.children.forEach(r=>{const a=t.find(e=>e.id===r);a.rels.mother||(i||(i=d({data:{gender:"F"},rels:{spouses:[e.id],children:[]}})),i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},i.rels.children.push(a.id),e.rels.spouses.push(i.id),a.rels.mother=i.id,t.push(i)),a.rels.father||(i||(i=d({data:{gender:"M"},rels:{spouses:[e.id],children:[]}})),i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},i.rels.children.push(a.id),e.rels.spouses.push(i.id),a.rels.father=i.id,t.push(i))})}}(),function(){e.rels.spouses||(e.rels.spouses=[]);const i=d({data:{gender:"M"===e.data.gender?"F":"M"},rels:{spouses:[e.id]}});i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},e.rels.spouses.push(i.id),t.push(i)}()),r.child&&(e.rels.children||(e.rels.children=[]),e.rels.spouses||(e.rels.spouses=[]),e.rels.spouses.forEach(i=>{const r=t.find(e=>e.id===i),a="M"===e.data.gender?r.id:e.id,s="F"===e.data.gender?r.id:e.id;r.rels.children||(r.rels.children=[]);const o=d({data:{gender:"M"},rels:{father:s,mother:a}});o._new_rel_data={rel_type:"son",label:n.son,other_parent_id:r.id,rel_id:e.id},r.rels.children.push(o.id),e.rels.children.push(o.id),t.push(o);const l=d({data:{gender:"F"},rels:{mother:a,father:s}});l._new_rel_data={rel_type:"daughter",label:n.daughter,other_parent_id:r.id,rel_id:e.id},r.rels.children.push(l.id),e.rels.children.push(l.id),t.push(l)}))}(e,this.getStoreData(),this.addRelLabels,this.canAdd),t.updateTree({}),this.onChange=function(i,r){(null==i?void 0:i._new_rel_data)?(null==r?void 0:r.link_rel_id)?at(i,r.link_rel_id,t.getData()):delete i._new_rel_data:i.id===e.id?i.data.gender!==n&&(n=i.data.gender,t.getData().forEach(e=>{const t=e._new_rel_data;t&&("spouse"===t.rel_type&&(e.data.gender="M"===e.data.gender?"F":"M"),["son","daughter"].includes(t.rel_type)&&([e.rels.father,e.rels.mother]=[e.rels.mother,e.rels.father]))})):console.error("Something went wrong")},this.onCancel=()=>function(e){if(!e.is_active)return;e.is_active=!1,e.store.state.one_level_rels=!1,e.cleanUp(),e.cancelCallback(e.datum),e.datum=null,e.onChange=null,e.onCancel=null}(this)}setAddRelLabels(e){if("object"==typeof e){for(const t in e){const n=t;this.addRelLabels[n]=e[n]}return this}console.error("add_rel_labels must be an object")}setCanAdd(e){return this.canAdd=e,this}addRelLabelsDefault(){return{father:"Add Father",mother:"Add Mother",spouse:"Add Spouse",son:"Add Son",daughter:"Add Daughter"}}getStoreData(){return this.store.getData()}cleanUp(e){return e||(e=this.store.getData()),function(e){for(let t=e.length-1;t>=0;t--){const n=e[t];n._new_rel_data&&(e.forEach(e=>{e.rels.father===n.id&&delete e.rels.father,e.rels.mother===n.id&&delete e.rels.mother,e.rels.children&&e.rels.children.includes(n.id)&&e.rels.children.splice(e.rels.children.indexOf(n.id),1),e.rels.spouses&&e.rels.spouses.includes(n.id)&&e.rels.spouses.splice(e.rels.spouses.indexOf(n.id),1)}),e.splice(t,1))}}(e),e}}class dt{constructor(e,t,n,i){return this.store=e,this.onActivate=t,this.cancelCallback=n,this.modal=i,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this}activate(e){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;const t=this.store;t.updateTree({}),this.datum=e,this.onChange=function(n,r){const a=function(t){if(t.is_ancestry){if(e.rels.father===t.data.id)return"father";if(e.rels.mother===t.data.id)return"mother"}else if(t.spouse){if(!e.rels.spouses)throw new Error("Spouses not found");if(e.rels.spouses.includes(t.data.id))return"spouse"}else{if(!e.rels.children)throw new Error("Children not found");if(e.rels.children.includes(t.data.id))return"children"}return null}(n),s=e.rels;"father"===a?function(){const n=t.getDatum(s.father);if(!n)throw new Error("Father not found");if(!n.rels.children)throw new Error("Father has no children");n.rels.children=n.rels.children.filter(t=>t!==e.id),s.father=void 0,r()}.call(this):"mother"===a?function(){const n=t.getDatum(s.mother);if(!n)throw new Error("Mother not found");if(!n.rels.children)throw new Error("Mother has no children");n.rels.children=n.rels.children.filter(t=>t!==e.id),s.mother=void 0,r()}.call(this):"spouse"===a?function(){const a=n.data;o()?l.call(this):d.call(this,!0);function o(){return(a.rels.children||[]).some(e=>{const n=t.getDatum(e);if(!n)throw new Error("Child not found");return n.rels.father===a.id||n.rels.mother===a.id})}function l(){const t="M"===e.data.gender?"f3-male-bg":"F"===e.data.gender?"f3-female-bg":null,n="M"===a.data.gender?"f3-male-bg":"F"===a.data.gender?"f3-female-bg":null,r=i.create("div").html(`\n            <p>You are removing a spouse relationship. Since there are shared children, please choose which parent should keep them in the family tree.</p>\n            <div class="f3-modal-options">\n              <button data-option="assign-to-current" class="f3-btn ${t}">Keep children with current person</button>\n              <button data-option="assign-to-spouse" class="f3-btn ${n}">Keep children with spouse</button>\n            </div>\n          `);r.selectAll('[data-option="assign-to-current"]').on("click",()=>{d(!0),this.modal.close()}),r.selectAll('[data-option="assign-to-spouse"]').on("click",()=>{d(!1),this.modal.close()}),this.modal.activate(r.node())}function d(i){n.data.rels.spouses=n.data.rels.spouses.filter(t=>t!==e.id),s.spouses=s.spouses.filter(e=>e!==n.data.id);const a=i?e:n.data,o=i?n.data:e;(s.children||[]).forEach(e=>{const n=t.getDatum(e);if(!n)throw new Error("Child not found");n.rels.father===o.id&&(n.rels.father=void 0),n.rels.mother===o.id&&(n.rels.mother=void 0)}),o.rels.children&&(o.rels.children=o.rels.children.filter(e=>!(a.rels.children||[]).includes(e))),r()}}.call(this):"children"===a&&function(){if(!s.children)throw new Error("Children not found");s.children=s.children.filter(e=>e!==n.data.id);const t=n.data.rels.father===e.id?"father":"mother";n.data.rels[t]=void 0,r()}.call(this)}.bind(this),this.onCancel=function(){if(!this.is_active)return;if(this.is_active=!1,this.store.state.one_level_rels=!1,!this.datum)throw new Error("Datum not found");this.cancelCallback(this.datum),this.datum=null,this.onChange=null,this.onCancel=null}.bind(this)}}class ct{constructor(e){this.cont=e,this.active=!1,this.onClose=null,this.modal_cont=i.select(this.cont).append("div").attr("class","f3-modal").node(),i.select(this.modal_cont).style("display","none"),this.create()}create(){const e=i.select(this.modal_cont);e.html('\n      <div class="f3-modal-content">\n        <span class="f3-modal-close">&times;</span>\n        <div class="f3-modal-content-inner"></div>\n        <div class="f3-modal-content-bottom"></div>\n      </div>\n    '),e.select(".f3-modal-close").on("click",()=>{this.close()}),e.on("click",t=>{t.target==e.node()&&this.close()})}activate(e,{boolean:t,onAccept:n,onCancel:r}={}){this.reset();const a=i.select(this.modal_cont).select(".f3-modal-content-inner").node();if("string"==typeof e?a.innerHTML=e:a.appendChild(e),t){if(!n)throw new Error("onAccept is required");if(!r)throw new Error("onCancel is required");i.select(this.modal_cont).select(".f3-modal-content-bottom").html('\n        <button class="f3-modal-accept f3-btn">Accept</button>\n        <button class="f3-modal-cancel f3-btn">Cancel</button>\n      '),i.select(this.modal_cont).select(".f3-modal-accept").on("click",()=>{n(),this.reset(),this.close()}),i.select(this.modal_cont).select(".f3-modal-cancel").on("click",()=>{this.close()}),this.onClose=r}this.open()}reset(){this.onClose=null,i.select(this.modal_cont).select(".f3-modal-content-inner").html(""),i.select(this.modal_cont).select(".f3-modal-content-bottom").html("")}open(){this.modal_cont.style.display="block",this.active=!0}close(){this.modal_cont.style.display="none",this.active=!1,this.onClose&&this.onClose()}}class ht{constructor(e,t){return this.cont=e,this.store=t,this.fields=[{type:"text",label:"first name",id:"first name"},{type:"text",label:"last name",id:"last name"},{type:"text",label:"birthday",id:"birthday"},{type:"text",label:"avatar",id:"avatar"}],this.is_fixed=!0,this.no_edit=!1,this.onChange=null,this.editFirst=!1,this.postSubmit=null,this.onFormCreation=null,this.createFormEdit=null,this.createFormNew=null,this.formCont=this.getFormContDefault(),this.modal=this.setupModal(),this.addRelativeInstance=this.setupAddRelative(),this.removeRelativeInstance=this.setupRemoveRelative(),this.history=this.createHistory(),this}open(e){e.rels||(e=e.data),this.addRelativeInstance.is_active?function(t){e._new_rel_data?t.cardEditForm(e):(t.addRelativeInstance.onCancel(),t.cardEditForm(e),t.store.updateMainId(e.id),t.store.updateTree({}))}(this):this.removeRelativeInstance.is_active?function(t,n){if(!n)throw new Error("Tree datum not found");if(!t.removeRelativeInstance.datum)throw new Error("Remove relative datum not found");if(!t.removeRelativeInstance.onCancel)throw new Error("Remove relative onCancel not found");if(!t.removeRelativeInstance.onChange)throw new Error("Remove relative onChange not found");if(e.id===t.removeRelativeInstance.datum.id)t.removeRelativeInstance.onCancel(),t.cardEditForm(e);else{function i(){t.removeRelativeInstance.onCancel(),t.updateHistory(),t.store.updateTree({})}t.removeRelativeInstance.onChange(n,i.bind(t))}}(this,this.store.getTreeDatum(e.id)):this.cardEditForm(e)}setupAddRelative(){return((e,t,n)=>new lt(e,t,n))(this.store,()=>function(e){e.removeRelativeInstance.is_active&&e.removeRelativeInstance.onCancel()}(this),e=>function(e,t){e.store.updateMainId(t.id),e.store.updateTree({}),e.openFormWithId(t.id)}(this,e))}setupRemoveRelative(){return((e,t,n,i)=>new dt(e,t,n,i))(this.store,function(){this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel();e(this.cont,!0)}.bind(this),function(t){e(this.cont,!1),this.store.updateMainId(t.id),this.store.updateTree({}),this.openFormWithId(t.id)}.bind(this),this.modal);function e(e,t){i.select(e).select("#f3Canvas").classed("f3-remove-relative-active",t)}}createHistory(){const e=Te(this.store,this.getStoreDataCopy.bind(this),function(){var e;console.log("historyUpdateTree"),this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel();this.removeRelativeInstance.is_active&&this.removeRelativeInstance.onCancel();this.store.updateTree({initial:!1}),this.history.controls.updateButtons(),this.openFormWithId(null===(e=this.store.getMainDatum())||void 0===e?void 0:e.id),this.onChange&&this.onChange()}.bind(this)),t=this.cont.querySelector(".f3-nav-cont");if(!t)throw new Error("Nav cont not found");const n=Pe(t,e);return e.changed(),n.updateButtons(),Object.assign(Object.assign({},e),{controls:n})}openWithoutRelCancel(e){this.cardEditForm(e)}getFormContDefault(){let e=i.select(this.cont).select("div.f3-form-cont").node();return e||(e=i.select(this.cont).append("div").classed("f3-form-cont",!0).node()),{el:e,populate(t){e.innerHTML="",e.appendChild(t)},open(){i.select(e).classed("opened",!0)},close(){i.select(e).classed("opened",!1).html("")}}}setFormCont(e){return this.formCont=e,this}cardEditForm(e){const t={},n=null==e?void 0:e._new_rel_data;n?t.onCancel=()=>this.addRelativeInstance.onCancel():(t.addRelative=this.addRelativeInstance,t.removeRelative=this.removeRelativeInstance,t.deletePerson=()=>{B(e,this.store.getData()),this.openFormWithId(this.store.getLastAvailableMainDatum().id),this.store.updateTree({})});const i=ot(Object.assign({store:this.store,datum:e,postSubmitHandler:t=>function(t,n){if(t.addRelativeInstance.is_active){t.addRelativeInstance.onChange(e,n),t.postSubmit&&t.postSubmit(e,t.store.getData());const i=t.addRelativeInstance.datum;if(!i)throw new Error("Active datum not found");t.store.updateMainId(i.id),t.openWithoutRelCancel(i)}else(e.to_add||e.unknown)&&(null==n?void 0:n.link_rel_id)?(at(e,n.link_rel_id,t.store.getData()),t.store.updateMainId(n.link_rel_id),t.openFormWithId(n.link_rel_id)):(null==n?void 0:n.delete)||(t.postSubmit&&t.postSubmit(e,t.store.getData()),t.openFormWithId(e.id));t.is_fixed||t.closeForm();t.store.updateTree({}),t.updateHistory()}(this,t),fields:this.fields,onCancel:()=>{},editFirst:this.editFirst,no_edit:this.no_edit,link_existing_rel_config:this.link_existing_rel_config,onFormCreation:this.onFormCreation,onSubmit:this.onSubmit,onDelete:this.onDelete,canEdit:this.canEdit,canDelete:this.canDelete},t)),r=n?(this.createFormNew||De)(i,this.closeForm.bind(this)):(this.createFormEdit||Fe)(i,this.closeForm.bind(this));this.formCont.populate(r),this.openForm()}openForm(){this.formCont.open()}closeForm(){this.formCont.close(),this.store.updateTree({})}fixed(){return this.is_fixed=!0,this.formCont.el&&i.select(this.formCont.el).style("position","relative"),this}absolute(){return this.is_fixed=!1,this.formCont.el&&i.select(this.formCont.el).style("position","absolute"),this}setCardClickOpen(e){return e.setOnCardClick((t,n)=>{this.isAddingRelative()||this.isRemovingRelative()?this.open(n.data):(this.open(n.data),e.onCardClickDefault(t,n))}),this}openFormWithId(e){if(e){const t=this.store.getDatum(e);if(!t)throw new Error("Datum not found");this.openWithoutRelCancel(t)}else{const e=this.store.getMainDatum();if(!e)throw new Error("Main datum not found");this.openWithoutRelCancel(e)}}setNoEdit(){return this.no_edit=!0,this}setEdit(){return this.no_edit=!1,this}setFields(e){const t=[];if(!Array.isArray(e))return console.error("fields must be an array"),this;for(const n of e)"string"==typeof n?t.push({type:"text",label:n,id:n}):"object"==typeof n?n.id?t.push(n):console.error("fields must be an array of objects with id property"):console.error("fields must be an array of strings or objects");return this.fields=t,this}setOnChange(e){return this.onChange=e,this}setCanEdit(e){return this.canEdit=e,this}setCanDelete(e){return this.canDelete=e,this}setCanAdd(e){return this.addRelativeInstance.setCanAdd(e),this}addRelative(e){return e||(e=this.store.getMainDatum()),this.addRelativeInstance.activate(e),this}setupModal(){return e=this.cont,new ct(e);var e}setEditFirst(e){return this.editFirst=e,this}isAddingRelative(){return this.addRelativeInstance.is_active}isRemovingRelative(){return this.removeRelativeInstance.is_active}setAddRelLabels(e){return this.addRelativeInstance.setAddRelLabels(e),this}setLinkExistingRelConfig(e){return this.link_existing_rel_config=e,this}setOnFormCreation(e){return this.onFormCreation=e,this}setCreateFormEdit(e){return this.createFormEdit=e,this}setCreateFormNew(e){return this.createFormNew=e,this}getStoreDataCopy(){let e=JSON.parse(JSON.stringify(this.store.getData()));return this.addRelativeInstance.is_active&&(e=this.addRelativeInstance.cleanUp(e)),e=Z(e),e}getDataJson(){return JSON.stringify(this.getStoreDataCopy(),null,2)}updateHistory(){this.history&&(this.history.changed(),this.history.controls.updateButtons()),this.onChange&&this.onChange()}setPostSubmit(e){return this.postSubmit=e,this}setOnSubmit(e){return this.onSubmit=e,this}setOnDelete(e){return this.onDelete=e,this}destroy(){return this.history.controls.destroy(),this.history=null,this.formCont.el&&i.select(this.formCont.el).remove(),this.addRelativeInstance.onCancel&&this.addRelativeInstance.onCancel(),this.store.updateTree({}),this}}class ut{constructor(e,t,n={}){this.cont=e,this.options=[],this.onSelect=t,this.config=n,this.autocomplete_cont=i.select(this.cont).append("div").attr("class","f3-autocomplete-cont").node(),this.create()}create(){var e;const t=this;i.select(this.autocomplete_cont).html(`\n      <div class="f3-autocomplete">\n        <div class="f3-autocomplete-input-cont">\n          <input type="text" placeholder="${(null===(e=this.config)||void 0===e?void 0:e.placeholder)||"Search"}">\n          <span class="f3-autocomplete-toggle">${Ce()}</span>\n        </div>\n        <div class="f3-autocomplete-items" tabindex="0"></div>\n      </div>\n    `);const n=i.select(this.autocomplete_cont).select(".f3-autocomplete"),r=n.select("input"),a=n.select(".f3-autocomplete-items");function s(){n.classed("active",!0);const e=r.property("value"),i=t.options.filter(t=>t.label.toLowerCase().includes(e.toLowerCase()));i.forEach(function(t){const n=t.label.toLowerCase().indexOf(e.toLowerCase());t.label_html=-1!==n?t.label.substring(0,n)+"<strong>"+t.label.substring(n,n+e.length)+"</strong>"+t.label.substring(n+e.length):t.label}),i.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),l(i)}function o(){n.classed("active",!1),l([])}function l(e){a.selectAll("div.f3-autocomplete-item").data(e,e=>null==e?void 0:e.value).join("div").attr("class","f3-autocomplete-item").on("click",(e,n)=>{t.onSelect(n.value)}).html(e=>e.optionHtml?e.optionHtml(e):function(e){return`<div class="${e.class?e.class:""}">${e.label_html}</div>`}(e))}n.on("focusout",()=>{setTimeout(()=>{n.node().contains(document.activeElement)||o()},200)}),r.on("focus",()=>{t.options=t.getOptions(),s()}).on("input",s).on("keydown",function(e){const n=a.selectAll("div.f3-autocomplete-item").nodes(),r=n.findIndex(e=>i.select(e).classed("f3-selected"));if("ArrowDown"===e.key){e.preventDefault();s(n,r<n.length-1?r+1:0)}else if("ArrowUp"===e.key){e.preventDefault();s(n,r>0?r-1:n.length-1)}else if("Enter"===e.key&&-1!==r){e.preventDefault();const a=i.select(n[r]).datum();a&&t.onSelect(a.value)}function s(e,t){e.forEach(e=>i.select(e).classed("f3-selected",!1)),e[t]&&(i.select(e[t]).classed("f3-selected",!0),e[t].scrollIntoView({block:"nearest"}))}}),a.on("wheel",e=>e.stopPropagation()),n.select(".f3-autocomplete-toggle").on("click",e=>{e.stopPropagation();const t=n.classed("active");if(n.classed("active",!t),t)o();else{r.node().focus(),s()}})}setOptionsGetter(e){return this.getOptions=e,this}setOptionsGetterPerson(e,t){return this.getOptions=()=>{const i=[];return e().forEach(e=>{e.to_add||e.unknown||e._new_rel_data||i.find(t=>t.value===e.id)||i.push({label:t(e),value:e.id,optionHtml:n(e)})}),i},this;function n(t){const n=!j(t,e());return e=>`\n        <div>\n          <span style="float: left; width: 10px; height: 10px; margin-right: 10px;" class="f3-${function(e){return"M"===e.data.gender?"male":"F"===e.data.gender?"female":"genderless"}(t)}-color">${ye()}</span>\n          <span>${e.label_html}</span>\n          ${n?`<span style="float: right; width: 10px; height: 10px; margin-left: 5px;" title="This profile is not connected to the main profile">${$e()}</span>`:""}\n        </div>\n      `}}destroy(){this.autocomplete_cont.remove()}}function ft(e){const t=[];return Array.isArray(e)?e.forEach(e=>{"function"==typeof e?t.push(e):"string"==typeof e?t.push(t=>t.data[e]):Array.isArray(e)&&t.push(t=>e.map(e=>t.data[e]).join(" "))}):"function"==typeof e?t.push(e):"string"==typeof e&&t.push(t=>t.data[e]),t}function pt(e,t){return new _t(e,t)}let _t=class{constructor(e,t){return this.cont=e,this.svg=this.cont.querySelector("svg.main_svg"),this.store=t,this.card_display=[e=>`${e.data["first name"]} ${e.data["last name"]}`],this.cardImageField="avatar",this.onCardClick=this.onCardClickDefault,this.style="default",this.mini_tree=!1,this.card_dim={},this}getCard(){return Je({store:this.store,card_display:this.card_display,cardImageField:this.cardImageField,defaultPersonIcon:this.defaultPersonIcon,onCardClick:this.onCardClick,style:this.style,mini_tree:this.mini_tree,onCardUpdate:this.onCardUpdate,card_dim:this.card_dim,empty_card_label:this.store.state.single_parent_empty_card_label||"",unknown_card_label:this.store.state.unknown_card_label||"",cardInnerHtmlCreator:this.cardInnerHtmlCreator,duplicate_branch_toggle:this.store.state.duplicate_branch_toggle,onCardMouseenter:this.onCardMouseenter?this.onCardMouseenter.bind(this):void 0,onCardMouseleave:this.onCardMouseleave?this.onCardMouseleave.bind(this):void 0})}setCardDisplay(e){return this.card_display=ft(e),this}setCardImageField(e){return this.cardImageField=e,this}setDefaultPersonIcon(e){return this.defaultPersonIcon=e,this}setOnCardClick(e){return this.onCardClick=e,this}onCardClickDefault(e,t){this.store.updateMainId(t.data.id),this.store.updateTree({})}setStyle(e){return this.style=e,this}setMiniTree(e){return this.mini_tree=e,this}setOnCardUpdate(e){return this.onCardUpdate=e,this}setCardDim(e){if("object"!=typeof e)return console.error("card_dim must be an object"),this;for(let t in e){const n=e[t];if("number"!=typeof n&&"boolean"!=typeof n)return console.error(`card_dim.${t} must be a number or boolean`),this;"width"===t&&(t="w"),"height"===t&&(t="h"),"img_width"===t&&(t="img_w"),"img_height"===t&&(t="img_h"),"img_x"===t&&(t="img_x"),"img_y"===t&&(t="img_y"),this.card_dim[t]=n}return this}resetCardDim(){return this.card_dim={},this}setCardInnerHtmlCreator(e){return this.cardInnerHtmlCreator=e,this}setOnHoverPathToMain(){return this.onCardMouseenter=this.onEnterPathToMain.bind(this),this.onCardMouseleave=this.onLeavePathToMain.bind(this),this}unsetOnHoverPathToMain(){return this.onCardMouseenter=void 0,this.onCardMouseleave=void 0,this}onEnterPathToMain(e,t){this.to_transition=t.data.id;const n=this.store.getTreeMainDatum(),r=i.select(this.cont).select("div.cards_view").selectAll(".card_cont"),a=i.select(this.cont).select("svg.main_svg .links_view").selectAll(".link"),{cards_node_to_main:s,links_node_to_main:o}=function(e,t,n,i){const r=n.is_ancestry,a=t.data();let s=[],o=[];if(r){const r=[];let c=n,h=0;for(;c!==i&&h<100;){h++;const e=a.find(e=>!0===e.spouse&&(e.source===c||e.target===c));if(e){const t=d(a.filter(t=>Array.isArray(t.target)&&t.target.includes(e.source)&&t.target.includes(e.target)),i);if(!t)break;r.push(e),r.push(t),c=t.source}else{const e=d(a.filter(e=>Array.isArray(e.target)&&e.target.includes(c)),i);if(!e)break;r.push(e),c=e.source}}t.each(function(e){r.includes(e)&&s.push({link:e,node:this})});const u=l(n,r);e.each(function(e){u.includes(e)&&o.push({card:e,node:this})})}else if(n.spouse&&n.spouse.data===i.data){t.each(function(e){e.target===n&&s.push({link:e,node:this})});const r=[i,n];e.each(function(e){r.includes(e)&&o.push({card:e,node:this})})}else if(n.sibling){t.each(function(e){if(!Array.isArray(n.parents))throw new Error("datum.parents is not an array");e.source===n&&s.push({link:e,node:this}),e.source===i&&Array.isArray(e.target)&&2===e.target.length&&s.push({link:e,node:this}),n.parents.includes(e.source)&&!Array.isArray(e.target)&&n.parents.includes(e.target)&&s.push({link:e,node:this})});const r=[i,n,...n.parents||[]];e.each(function(e){r.includes(e)&&o.push({card:e,node:this})})}else{let r=[],d=n,c=0;for(;d!==i&&c<100;){c++;const e=a.find(e=>e.target===d&&Array.isArray(e.source));if(e){const t=a.find(t=>{return!0===t.spouse&&(n=[t.source,t.target],i=e.source,n.every(e=>i.some(t=>e===t)));var n,i});r.push(e),r.push(t),d=t?t.source:e.source[0]}else{const e=a.find(e=>e.target===d&&!Array.isArray(e.source));if(!e)break;r.push(e),d=e.source}}t.each(function(e){r.includes(e)&&s.push({link:e,node:this})});const h=l(i,r);e.each(function(e){h.includes(e)&&o.push({card:e,node:this})})}return{cards_node_to_main:o,links_node_to_main:s};function l(e,t){const r=t.filter(e=>e).reduce((e,t)=>(Array.isArray(t.target)?e.push(...t.target):e.push(t.target),Array.isArray(t.source)?e.push(...t.source):e.push(t.source),e),[]),a=[i,n];return function e(t){t.data.rels.children&&t.data.rels.children.forEach(t=>{const n=r.find(e=>e.data.id===t);n&&(a.push(n),e(n))})}(e),a}function d(e,t){return 0===e.length?null:1===e.length?e[0]:e.find(e=>e.source===t)}}(r,a,t,n);return s.forEach(e=>{const n=200*Math.abs(t.depth-e.card.depth);i.select(e.node.querySelector("div.card-inner")).transition().duration(0).delay(n).on("end",()=>this.to_transition===t.data.id&&i.select(e.node.querySelector("div.card-inner")).classed("f3-path-to-main",!0))}),o.forEach(e=>{const n=200*Math.abs(t.depth-e.link.depth);i.select(e.node).transition().duration(0).delay(n).on("end",()=>this.to_transition===t.data.id&&i.select(e.node).classed("f3-path-to-main",!0))}),this}onLeavePathToMain(e,t){return this.to_transition=!1,i.select(this.cont).select("div.cards_view").selectAll("div.card-inner").classed("f3-path-to-main",!1),i.select(this.cont).select("svg.main_svg .links_view").selectAll(".link").classed("f3-path-to-main",!1),this}};function mt(e,t){return new gt(e,t)}let gt=class{constructor(e,t){return this.cont=e,this.store=t,this.svg=this.cont.querySelector("svg.main_svg"),this.card_dim={w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5},this.card_display=[],this.mini_tree=!0,this.link_break=!1,this.onCardClick=this.onCardClickDefault.bind(this),this}getCard(){return Ge({store:this.store,svg:this.svg,card_dim:this.card_dim,card_display:this.card_display,mini_tree:this.mini_tree,link_break:this.link_break,onCardClick:this.onCardClick,onCardUpdate:this.onCardUpdate})}setCardDisplay(e){return this.card_display=ft(e),this}setCardDim(e){if("object"!=typeof e)return console.error("card_dim must be an object"),this;for(let t in e){const n=e[t];if("number"!=typeof n&&"boolean"!=typeof n)return console.error(`card_dim.${t} must be a number or boolean`),this;"width"===t&&(t="w"),"height"===t&&(t="h"),"img_width"===t&&(t="img_w"),"img_height"===t&&(t="img_h"),"img_x"===t&&(t="img_x"),"img_y"===t&&(t="img_y"),this.card_dim[t]=n}return function(e,t){e.querySelector("defs#f3CardDef")&&e.querySelector("defs#f3CardDef").remove(),We(e,t)}(this.svg,this.card_dim),this}setOnCardUpdate(e){return this.onCardUpdate=e,this}setMiniTree(e){return this.mini_tree=e,this}setLinkBreak(e){return this.link_break=e,this}onCardClickDefault(e,t){this.store.updateMainId(t.data.id),this.store.updateTree({})}setOnCardClick(e){return this.onCardClick=e,this}};function vt(e,t){return new yt(e,t)}class yt{constructor(e,t){this.getCard=null,this.transition_time=2e3,this.linkSpouseText=null,this.personSearch=null,this.is_card_html=!1,this.beforeUpdate=null,this.afterUpdate=null,this.cont=function(e){"string"==typeof e&&(e=document.querySelector(e));if(!e)throw new Error("cont not found");return e}(e);const{svg:n}=I(this.cont);this.svg=n,function(e){i.select(e).append("div").attr("class","f3-nav-cont")}(this.cont);const r=t&&t.length>0?t[0].id:"";return this.store=this.createStore(t,r),this.setOnUpdate(),this.editTreeInstance=null,this}createStore(e,t){return m({data:e,main_id:t,node_separation:250,level_separation:150,single_parent_empty_card:!0,is_horizontal:!1})}setOnUpdate(){this.store.setOnUpdate(e=>{this.beforeUpdate&&this.beforeUpdate(e),e=Object.assign({transition_time:this.store.state.transition_time},e||{}),this.is_card_html&&(e=Object.assign({},e||{},{cardHtml:!0})),O(this.store.getTree(),this.svg,this.getCard(),e||{}),this.linkSpouseText&&function(e,t,n){const r=[];t.data.forEach(e=>{e.coparent&&"F"===e.data.data.gender&&r.push({nodes:[e,e.coparent],id:`${e.data.id}--${e.coparent.data.id}`}),e.spouses&&e.spouses.forEach(t=>r.push({nodes:[t,e],id:`${t.data.id}--${e.data.id}`}))});const a=i.select(e).select(".links_view").selectAll("g.link-text").data(r,e=>e.id),s=a.exit(),o=a.enter().append("g").attr("class","link-text"),l=o.merge(a),d=(e,t)=>e.spouse&&"F"===e.data.data.gender?e.x-n.node_separation/2:t.spouse&&"M"===t.data.data.gender?t.x+n.node_separation/2:Math.min(e.x,t.x)+n.node_separation/2;s.each(function(e){const t=i.select(this);t.transition("text").duration(100).style("opacity",0).on("end",()=>t.remove())}),o.each(function(e){const[t,n]=e.nodes,r=i.select(this);r.attr("transform",`translate(${d(t,n)}, ${t.y-3})`).style("opacity",0),r.append("text").style("font-size","12px").style("fill","#fff").style("text-anchor","middle")}),l.each(function(e){const[r,a]=e.nodes,s=i.select(this),o=n.initial?h(t,r,n.transition_time):0;s.select("text").text(n.linkSpouseText(r,a)),s.transition("text").duration(n.transition_time).delay(o).attr("transform",`translate(${d(r,a)}, ${r.y-3})`),s.transition("text-op").duration(100).delay(o+n.transition_time).style("opacity",1)})}(this.svg,this.store.getTree(),Object.assign({},e||{},{linkSpouseText:this.linkSpouseText,node_separation:this.store.state.node_separation})),this.afterUpdate&&this.afterUpdate(e)})}updateTree(e={initial:!1}){return this.store.updateTree(e),this}updateData(e){return this.store.updateData(e),this}setCardYSpacing(e){return"number"!=typeof e?(console.error("card_y_spacing must be a number"),this):(this.store.state.level_separation=e,this)}setCardXSpacing(e){return"number"!=typeof e?(console.error("card_x_spacing must be a number"),this):(this.store.state.node_separation=e,this)}setOrientationVertical(){return this.store.state.is_horizontal=!1,this}setOrientationHorizontal(){return this.store.state.is_horizontal=!0,this}setShowSiblingsOfMain(e){return this.store.state.show_siblings_of_main=e,this}setModifyTreeHierarchy(e){return this.store.state.modifyTreeHierarchy=e,this}setPrivateCardsConfig(e){return this.store.state.private_cards_config=e,this}setLinkSpouseText(e){return this.linkSpouseText=e,this}setSingleParentEmptyCard(e,{label:t="Unknown"}={}){return this.store.state.single_parent_empty_card=e,this.store.state.single_parent_empty_card_label=t,this.editTreeInstance&&this.editTreeInstance.addRelativeInstance.is_active&&this.editTreeInstance.addRelativeInstance.onCancel(),J(this.store.getData()||[]),this}setCard(e){if(e===pt)return this.setCardHtml();if(e===mt)return this.setCardSvg();throw new Error("Card must be an instance of cardHtml or cardSvg")}setCardHtml(){const e=this.cont.querySelector("#htmlSvg");if(!e)throw new Error("htmlSvg not found");this.is_card_html=!0,this.svg.querySelector(".cards_view").innerHTML="",e.style.display="block";const t=pt(this.cont,this.store);return this.getCard=()=>t.getCard(),t}setCardSvg(){const e=this.cont.querySelector("#htmlSvg");if(!e)throw new Error("htmlSvg not found");this.is_card_html=!1,this.svg.querySelector(".cards_view").innerHTML="",e.style.display="none";const t=mt(this.cont,this.store);return this.getCard=()=>t.getCard(),t}setTransitionTime(e){return this.store.state.transition_time=e,this}setSortChildrenFunction(e){return this.store.state.sortChildrenFunction=e,this}setSortSpousesFunction(e){return this.store.state.sortSpousesFunction=e,this}setAncestryDepth(e){return this.store.state.ancestry_depth=e,this}setProgenyDepth(e){return this.store.state.progeny_depth=e,this}getMaxDepth(e){return l(e,this.store.getData())}calculateKinships(e,t={}){return Xe(e,this.store.getData(),t)}getKinshipsDataStash(e,t){return rt(e,t,this.store.getData(),this.calculateKinships(e))}setDuplicateBranchToggle(e){return this.store.state.duplicate_branch_toggle=e,this}editTree(){return this.editTreeInstance=(e=this.cont,t=this.store,new ht(e,t));var e,t}updateMain(e){let t;return t=e.id?e.id:e.data.id,this.store.updateMainId(t),this.store.updateTree({}),this}updateMainId(e){return this.store.updateMainId(e),this}getMainDatum(){return this.store.getMainDatum()}setBeforeUpdate(e){return this.beforeUpdate=e,this}setAfterUpdate(e){return this.afterUpdate=e,this}setPersonDropdown(e,{cont:t=this.cont.querySelector(".f3-nav-cont"),onSelect:n,placeholder:i="Search"}={}){return n||(n=function(e){const t=this.store.getDatum(e);if(!t)throw new Error("Datum not found");this.editTreeInstance&&this.editTreeInstance.open(t);this.updateMainId(e),this.updateTree({initial:!1})}.bind(this)),this.personSearch=function(e,t,n={}){return new ut(e,t,n)}(t,n,{placeholder:i}),this.personSearch.setOptionsGetterPerson(this.store.getData,e),this}unSetPersonSearch(){return this.personSearch.destroy(),this.personSearch=null,this}}function wt(e){return(e=e[0].toUpperCase()+e.slice(1)).includes("great-")&&(e=e.replace("great-","Great-")),e}var bt=Object.freeze({__proto__:null,Card:Ke,CardHtml:Je,CardSvg:Ge,appendElement:Ze,infoPopup:Ye,kinshipInfo:function(e,t,n){const{self_id:r,getLabel:a,title:s}=e,o=Xe(r,n,e),l=o[t];if(!l)return;let d=l;d="self"===l?"You":wt(d);const c=`\n    <div class="f3-kinship-info">\n      <div class="f3-info-field">\n        <span class="f3-info-field-label">${s}</span>\n        <span class="f3-info-field-value">\n          <span>${d}</span>\n          <span class="f3-kinship-info-icon">${ke()}</span>\n        </span>\n      </div>\n    </div>\n  `,h=i.create("div").html(c).select("div").node();let u=null;return i.select(h).select(".f3-kinship-info-icon").on("click",e=>function(e,s){const l=250,d=400;let c=e.clientX-l-10,h=e.clientY-d-10;c+l>window.innerWidth&&(c=window.innerWidth-l-10);h<0&&(h=10);if(u&&u.active)return u.close(),void(u=null);u=Ye(s),i.select(u.popup_cont).style("width",`${l}px`).style("height",`${d}px`).style("left",`${c}px`).style("top",`${h}px`);const f=u.popup_cont.querySelector(".f3-popup-content-inner");u.activate(),function(e,t,n,r,a,s){i.select(a).select("#SmallChart").node()||i.select(a).append("div").attr("id","SmallChart").attr("class","f3");const o=i.select("#SmallChart");o.selectAll("*").remove();const l=rt(e,t,n,r);let d=!0;const c=o.append("div");function h(e){const n=vt("#SmallChart",e).setTransitionTime(500).setCardXSpacing(170).setCardYSpacing(70).setSingleParentEmptyCard(!1);function r(e){let n="self"===e.data.kinship?"You":e.data.kinship;return n=wt(n),d||(n=s(e.data)),`\n        <div class="card-inner card-rect ${i()}">\n          <div class="card-label">${n}</div>\n        </div>\n      `;function i(){return"self"===e.data.kinship?"card-kinship-self"+(d?"":" f3-real-label"):e.data.id===t?"card-kinship-rel":"card-kinship-default"}}function a(){c.classed("f3-kinship-labels-toggle",!0),c.append("label").text("Kinship labels").append("input").attr("type","checkbox").attr("checked",!0).on("change",e=>{d=!d,n.updateTree({initial:!1,tree_position:"inherit"})})}function o(e){const t=n.cont.querySelector("svg.main_svg");x(t).k>e&&C(t,e)}n.setCardHtml().setStyle("rect").setCardInnerHtmlCreator(e=>r(e)).setOnCardUpdate(function(e){i.select(this).select(".card").classed("card-main",!1)}).onCardClick=(e,t)=>{},n.updateTree({initial:!0}),setTimeout(()=>o(.65),100),a()}h(l)}(r,t,n,o,f,a)}(e,h)),h}});const xt=mt,Ct=pt,$t=Object.assign({},H,{setupHtmlSvg:function(e){i.select(e()).append("div").attr("class","cards_view_fake").style("display","none")},setupReactiveTreeData:F,getUniqueId:function(e){return e.unique_id}});var kt=Object.freeze({__proto__:null,CalculateTree:_,Card:Ke,CardHtml:Ct,CardHtmlClass:_t,CardSvg:xt,CardSvgClass:gt,calculateTree:p,cardHtml:pt,cardSvg:mt,createChart:vt,createStore:m,createSvg:M,elements:bt,handlers:qe,htmlHandlers:$t,icons:Me,view:O});e.CalculateTree=_,e.Card=Ke,e.CardHtml=Ct,e.CardHtmlClass=_t,e.CardSvg=xt,e.CardSvgClass=gt,e.calculateTree=p,e.cardHtml=pt,e.cardSvg=mt,e.createChart=vt,e.createStore=m,e.createSvg=M,e.default=kt,e.elements=bt,e.handlers=qe,e.htmlHandlers=$t,e.icons=Me,e.view=O,Object.defineProperty(e,"__esModule",{value:!0})});
